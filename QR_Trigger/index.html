<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>ACC New Form Redirect</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    :root{font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Arial}
    body{margin:0;display:grid;place-items:center;min-height:100vh;background:#111;color:#eee}
    .card{width:96%;max-width:520px;background:#1b1b1b;border:1px solid #2a2a2a;border-radius:12px;padding:16px}
    h1{font-size:18px;margin:0 0 8px}
    p{margin:8px 0;line-height:1.45}
    .log{background:#0f0f0f;border:1px solid #242424;padding:10px;border-radius:8px;height:180px;overflow:auto;font-size:12px;white-space:pre-wrap}
    .btn{display:inline-block;padding:10px 14px;border-radius:8px;background:#3a81ff;color:#fff;text-decoration:none;border:0;cursor:pointer}
    .btn:disabled{opacity:.6;cursor:not-allowed}
    .row{display:flex;gap:8px;flex-wrap:wrap}
  </style>
</head>
<body>
  <div class="card">
    <h1>ACC new form</h1>
    <p id="status">Starting…</p>
    <div class="row">
      <button id="startBtn" class="btn" style="display:none">Sign in and create form</button>
      <button id="resetBtn" class="btn" style="display:none;background:#666">Reset</button>
    </div>
    <div class="log" id="log" aria-live="polite"></div>
  </div>

<script>
const CONFIG = {
  clientId: "NbT4Ri9gKKGNXHNCBzQF3pdk2r8PzNqhNjqb0Ak7rhBWGvb0",
  // Must exactly match the Redirect URI registered in your APS app (case and trailing slash matter)
  redirectUri: "https://sajusathish.github.io/fuel-log-review/QR_Trigger/",
  // Scopes are case-sensitive
  scopes: "data:read data:write account:read",
  // Defaults so the QR can be short; URL params override these
  defaultProjectId: "f94d12c8-f951-45a5-b1c3-8419a37750fb",
  defaultTemplateId: "904f2c31-f161-4f91-a20a-774e0df6d933"
};

const AUTH_BASE = "https://developer.api.autodesk.com/authentication/v2";
const API_BASE  = "https://developer.api.autodesk.com/acc/v1";

const q = new URLSearchParams(window.location.search);
const projectId  = q.get("project_id")  || CONFIG.defaultProjectId;
const templateId = q.get("template_id") || CONFIG.defaultTemplateId;
const titleParam = q.get("title") || "QR Form";
const statusParam = q.get("status") || "draft";

const ui = {
  status: document.getElementById("status"),
  log: document.getElementById("log"),
  startBtn: document.getElementById("startBtn"),
  resetBtn: document.getElementById("resetBtn")
};

function log(msg){ ui.log.textContent += (typeof msg==="string"?msg:JSON.stringify(msg,null,2)) + "\n"; }

function assertInputs(){
  if(!CONFIG.clientId) throw new Error("Missing clientId");
  if(!CONFIG.redirectUri) throw new Error("Missing redirectUri");
  if(!CONFIG.scopes) throw new Error("Missing scopes");
  if(!projectId) throw new Error("Missing project_id");
  if(!templateId) throw new Error("Missing template_id");
}

function b64url(buf){
  const bytes=new Uint8Array(buf); let str="";
  for(let i=0;i<bytes.byteLength;i++) str+=String.fromCharCode(bytes[i]);
  return btoa(str).replace(/\+/g,"-").replace(/\//g,"_").replace(/=+$/,"");
}
function randomString(len=64){
  const c="abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789-._~";
  const arr=new Uint8Array(len); crypto.getRandomValues(arr);
  return Array.from(arr).map(x=>c[x%c.length]).join("");
}
async function sha256(str){
  const enc=new TextEncoder().encode(str);
  return await crypto.subtle.digest("SHA-256",enc);
}

async function startOAuth(){
  const codeVerifier=randomString(64);
  const codeChallenge=b64url(await sha256(codeVerifier));
  const state=randomString(16);
  sessionStorage.setItem("pkce_verifier",codeVerifier);
  sessionStorage.setItem("oauth_state",state);
  sessionStorage.setItem("pending_params",JSON.stringify({projectId,templateId,titleParam,statusParam}));

  const authUrl=new URL(AUTH_BASE+"/authorize");
  authUrl.searchParams.set("response_type","code");
  authUrl.searchParams.set("client_id",CONFIG.clientId);
  authUrl.searchParams.set("redirect_uri",CONFIG.redirectUri);
  authUrl.searchParams.set("scope",CONFIG.scopes);
  authUrl.searchParams.set("code_challenge",codeChallenge);
  authUrl.searchParams.set("code_challenge_method","S256");
  authUrl.searchParams.set("state",state);

  log("Authorize URL:\n"+authUrl.toString());
  window.location = authUrl.toString();
}

async function exchangeCodeForToken(code,verifier){
  const body=new URLSearchParams();
  body.set("grant_type","authorization_code");
  body.set("client_id",CONFIG.clientId);
  body.set("code",code);
  body.set("redirect_uri",CONFIG.redirectUri);
  body.set("code_verifier",verifier);

  const res=await fetch(AUTH_BASE+"/token",{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded"},body});
  if(!res.ok){ const t=await res.text(); throw new Error("Token exchange failed: "+t); }
  return await res.json(); // { access_token, expires_in, token_type, refresh_token? }
}

async function createForm(accessToken, params){
  // Official create endpoint; JSON body required even if {}
  const url = `${API_BASE}/projects/${encodeURIComponent(params.projectId)}/forms`;
  const body = { templateId: params.templateId, title: params.titleParam, status: params.statusParam };
  log("POST "+url);
  const res = await fetch(url,{
    method:"POST",
    headers:{
      "Authorization":"Bearer "+accessToken,
      "Content-Type":"application/json",
      "Accept":"application/json"
    },
    body: JSON.stringify(body)
  });
  const data = await res.json().catch(()=>({}));
  if(!res.ok) throw new Error("Create failed "+res.status+": "+JSON.stringify(data));
  return data; // expect { id, webUrl? ... }
}

async function getFormById(accessToken, params, formId){
  // Try direct GET by id first; if not available, fallback to list
  const byIdUrl = `${API_BASE}/projects/${encodeURIComponent(params.projectId)}/forms/${encodeURIComponent(formId)}`;
  log("GET "+byIdUrl);
  let res = await fetch(byIdUrl,{ headers:{ "Authorization":"Bearer "+accessToken, "Accept":"application/json" } });
  if(res.ok){
    return await res.json();
  }
  // Fallback to list and match
  const listUrl = `${API_BASE}/projects/${encodeURIComponent(params.projectId)}/forms`;
  log("GET "+listUrl+" (fallback)");
  res = await fetch(listUrl,{ headers:{ "Authorization":"Bearer "+accessToken, "Accept":"application/json" } });
  if(!res.ok) return null;
  const json = await res.json();
  const hit = Array.isArray(json?.results) ? json.results.find(x=>x.id===formId) : null;
  return hit || null;
}

function resetFlow(){
  sessionStorage.clear();
  const clean = CONFIG.redirectUri + "?project_id="+encodeURIComponent(projectId)+"&template_id="+encodeURIComponent(templateId)+"&ts="+Date.now();
  window.location = clean;
}

async function main(){
  ui.startBtn.onclick = startOAuth;
  ui.resetBtn.onclick = resetFlow;

  try{ assertInputs(); }catch(e){
    ui.status.textContent=e.message;
    ui.startBtn.style.display="inline-block";
    ui.resetBtn.style.display="inline-block";
    log("Tip: open the github.io page, not the github.com repo view");
    return;
  }

  const url=new URL(window.location.href);
  const code=url.searchParams.get("code");
  const state=url.searchParams.get("state");

  if(!code){
    ui.status.textContent="Sign in required";
    ui.startBtn.style.display="inline-block";
    ui.resetBtn.style.display="inline-block";
    log("Ready to start OAuth");
    log("Configured scopes: "+CONFIG.scopes);
    log("Redirect URI: "+CONFIG.redirectUri);
    return;
  }

  ui.startBtn.style.display="none";
  ui.resetBtn.style.display="inline-block";
  ui.status.textContent="Exchanging code for token…";

  const expectedState=sessionStorage.getItem("oauth_state");
  if(state!==expectedState){ ui.status.textContent="State mismatch"; log("State mismatch"); return; }

  const verifier=sessionStorage.getItem("pkce_verifier");
  const pendingParams=JSON.parse(sessionStorage.getItem("pending_params")||"{}");

  try{
    const token=await exchangeCodeForToken(code,verifier);
    log("Token ok. Creating form…");
    ui.status.textContent="Creating form…";

    const created=await createForm(token.access_token,pendingParams);
    let targetUrl=created.webUrl || null;

    if(!targetUrl){
      const detail=await getFormById(token.access_token,pendingParams,created.id);
      targetUrl = detail?.webUrl || null;
    }

    if(targetUrl){
      ui.status.textContent="Redirecting to ACC…";
      history.replaceState({}, "", CONFIG.redirectUri + "?project_id="+encodeURIComponent(projectId)+"&template_id="+encodeURIComponent(templateId));
      window.location = targetUrl; // navigate to the created form
    }else{
      ui.status.textContent="Form created. Could not resolve webUrl.";
      log({created});
    }
  }catch(err){
    ui.status.textContent="Error";
    log(err.message||err);
  }
}
main();
</script>
</body>
</html>



