<!DOCTYPE html>
<html>
<head>
  <title>Processing...</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      text-align: center;
      padding-top: 50px;
      background: #f8f8f8;
    }
    .spinner {
      border: 6px solid #ccc;
      border-top: 6px solid #007bff;
      border-radius: 50%;
      width: 40px;
      height: 40px;
      animation: spin 1s linear infinite;
      margin: 20px auto;
    }
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    #table-container {
      max-width: 90%;
      margin: 20px auto;
      text-align: left;
      overflow-x: auto;
    }
  </style>
</head>
<body>

  <h2 id="message">Loading...</h2>
  <div id="spinner" class="spinner"></div>
  <div id="table-container" style="display:none;"></div>

  <script>
    // Helper: get query params
    function getParam(name) {
      const val = new URLSearchParams(window.location.search).get(name);
      console.log(`Param ${name}:`, val);
      return val;
    }

    // Robust base64 decode function
    function safeBase64Decode(str) {
      try {
        console.log('Raw input string:', str);

        // Remove whitespace/newlines
        let cleaned = str.replace(/\s+/g, '');
        console.log('Whitespace removed:', cleaned);

        // Decode URI components repeatedly until stable
        let prev;
        do {
          prev = cleaned;
          cleaned = decodeURIComponent(cleaned);
        } while (cleaned !== prev);
        console.log('After decodeURIComponent:', cleaned);

        // Replace URL-safe Base64 chars with standard Base64 chars
        cleaned = cleaned.replace(/-/g, '+').replace(/_/g, '/');
        console.log('After URL-safe char replacement:', cleaned);

        // Add padding '=' to make length multiple of 4
        while (cleaned.length % 4 !== 0) {
          cleaned += '=';
        }
        console.log('After padding:', cleaned);

        // Decode base64 string
        const decoded = atob(cleaned);
        console.log('Base64 decoded string:', decoded);
        return decoded;
      } catch (e) {
        console.error('Base64 decode error:', e);
        return null;
      }
    }

    const data = getParam('data');
    const formId = getParam('formId');
    const status = getParam('status');
    const reviewer = getParam('reviewer');

    if (data) {
      // Show table from base64 HTML data
      const decodedHtml = safeBase64Decode(data);
      if (decodedHtml) {
        document.getElementById('message').innerText = 'Daily Fuel Log Review';
        document.getElementById('spinner').style.display = 'none';
        const container = document.getElementById('table-container');
        container.style.display = 'block';
        container.innerHTML = decodedHtml;
      } else {
        document.getElementById('message').innerText = 'Error decoding table data.';
        document.getElementById('spinner').style.display = 'none';
      }
    }
    else if (formId && status && reviewer) {
      // Show submitting spinner & send webhook, then redirect to ACC form
      document.getElementById('message').innerText = 'Submitting your response...';

      const webhookURL = `https://webhooks.workato.com/webhooks/rest/b7ed69d5-2da6-44d3-befd-c64b497884e8/fuel-log-response?status=${encodeURIComponent(status)}&Reviewer=${encodeURIComponent(reviewer)}&FormIds=${encodeURIComponent(formId)}`;

      const accURL = `https://acc.autodesk.com/build/forms/projects/f94d12c8-f951-45a5-b1c3-8419a37750fb/field-reports/904f2c31-f161-4f91-a20a-774e0df6d933/reports/${encodeURIComponent(formId)}`;

      fetch(webhookURL)
        .catch(err => console.error('Webhook failed:', err))
        .finally(() => window.location.href = accURL);
    }
    else {
      // No valid params
      document.getElementById('message').innerText = 'Missing parameters. Please check your link.';
      document.getElementById('spinner').style.display = 'none';
      console.warn('No valid parameters found in URL');
    }
  </script>
</body>
</html>
