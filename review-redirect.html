<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Daily Fuel Log Review</title>

  <!-- Tabulator CSS -->
  <link href="https://unpkg.com/tabulator-tables@5.5.0/dist/css/tabulator_modern.min.css" rel="stylesheet">

  <style>
    body {
      margin: 20px;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: #f9fafb;
      color: #222;
      display: flex;
      flex-direction: column;
      align-items: center;
      min-height: 100vh;
    }
    h3 {
      align-self: flex-start;
      margin-bottom: 15px;
      font-weight: 700;
      color: #2c3e50;
      font-size: 1.8rem;
      user-select: none;
    }
    #fuel-log-table {
      width: 100vw;
      max-width: 1200px;
      height: 60vh; /* Adjust as needed */
    }
    .buttons {
      margin-top: 15px;
      display: flex;
      justify-content: center;
      gap: 20px;
      flex-wrap: wrap;
      max-width: 1200px;
      width: 100vw;
    }
    button {
      cursor: pointer;
      border: none;
      border-radius: 30px;
      padding: 12px 28px;
      font-size: 16px;
      font-weight: 600;
      color: white;
      box-shadow: 0 4px 8px rgb(0 0 0 / 0.15);
      transition: background-color 0.3s ease, box-shadow 0.2s ease, transform 0.15s ease;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      user-select: none;
      background-color: #2980b9;
    }
    button:hover:not(:disabled) {
      box-shadow: 0 6px 15px rgb(0 0 0 / 0.25);
      transform: translateY(-2px);
    }
    button:disabled {
      cursor: not-allowed;
      opacity: 0.6;
      box-shadow: none;
      transform: none;
    }
    button.approve {
      background-color: #27ae60;
    }
    button.approve:hover:not(:disabled) {
      background-color: #1e8449;
    }
    button.reject {
      background-color: #c0392b;
    }
    button.reject:hover:not(:disabled) {
      background-color: #922b21;
    }
    #statusText {
      margin-top: 15px;
      font-weight: 600;
      color: #34495e;
      user-select: none;
      min-height: 24px;
      max-width: 1200px;
      width: 100vw;
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 8px;
    }
    .loader {
      display: inline-block;
      width: 18px;
      height: 18px;
      border: 3px solid rgba(0,0,0,0.2);
      border-top: 3px solid #34495e;
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
      vertical-align: middle;
    }
    @keyframes spin {
      0% { transform: rotate(0deg);}
      100% { transform: rotate(360deg);}
    }
  </style>
</head>
<body>

  <h3>Daily Fuel Log Review - <span id="todayDate"></span></h3>

  <!-- Tabulator Table Placeholder -->
  <div id="fuel-log-table"></div>

  <div class="buttons">
    <button id="refreshBtn" aria-label="Refresh Table">üîÑ Refresh Table</button>
    <button id="approveBtn" class="approve" aria-label="Approve Selected">‚úÖ Approve</button>
    <button id="rejectBtn" class="reject" aria-label="Reject Selected">‚ùå Reject</button>
  </div>

  <div id="statusText" aria-live="polite" role="status"></div>

  <!-- Tabulator JS -->
  <script src="https://unpkg.com/tabulator-tables@5.5.0/dist/js/tabulator.min.js"></script>

  <script>
    document.getElementById("todayDate").textContent = new Date().toISOString().split("T")[0];

    // Decode base64 URL-safe encoded HTML to JSON array of objects
    function base64UrlDecode(input) {
      try {
        const base64 = input.replace(/-/g, '+').replace(/_/g, '/');
        const decoded = atob(base64);
        return decodeURIComponent(escape(decoded));
      } catch (e) {
        console.error("Error decoding base64:", e);
        return null;
      }
    }

    // Parse table HTML string into JSON data (rows/columns)
    function parseTableHTMLtoData(html) {
      const parser = new DOMParser();
      const doc = parser.parseFromString(html, "text/html");
      const table = doc.querySelector("table");
      if (!table) return [];

      const headers = Array.from(table.querySelectorAll("thead th")).map(th => th.textContent.trim());
      const rows = Array.from(table.querySelectorAll("tbody tr"));

      return rows.map(row => {
        const cells = Array.from(row.querySelectorAll("td"));
        let obj = {};
        cells.forEach((cell, idx) => {
          obj[headers[idx] || "col" + idx] = cell.textContent.trim();
          // If checkbox in cell, use its value for selection column
          const checkbox = cell.querySelector('input[type="checkbox"]');
          if(checkbox && checkbox.name === 'selectForm') {
            obj._selected = checkbox.checked;
            obj._selectValue = checkbox.value;
          }
        });
        return obj;
      });
    }

    // Initialize Tabulator Table with given data
    let table;
    function initTable(data, columns) {
      table = new Tabulator("#fuel-log-table", {
        data: data,
        layout:"fitDataStretch",
        movableColumns:true,
        resizableColumns:true,
        columns: columns,
        pagination:false,
        selectable:true,
        selectableRangeMode:"click",
        initialSort:[{column:columns[0].field, dir:"asc"}],
      });
    }

    // Columns will be derived from headers, adding a select checkbox column first
    function getColumnsFromHeaders(headers) {
      // Insert a selection checkbox column at start
      const cols = [{
        formatter:"rowSelection",
        titleFormatter:"rowSelection",
        hozAlign:"center",
        headerSort:false,
        width:50,
        frozen:true,
        cellClick:function(e, cell){
          cell.getRow().toggleSelect();
        }
      }];

      headers.forEach(hdr => {
        cols.push({
          title: hdr,
          field: hdr,
          headerFilter:"input",
          headerSort:true,
          resizable:true,
          hozAlign:"left",
          tooltip:true,
        });
      });
      return cols;
    }

    // Get URL params
    const params = new URLSearchParams(window.location.search);
    const dataEncoded = params.get('data');
    const reviewer = params.get('reviewer') || 'unknown@domain.com';

    if(dataEncoded){
      const tableHTML = base64UrlDecode(dataEncoded);
      if(tableHTML){
        const parser = new DOMParser();
        const doc = parser.parseFromString(tableHTML, "text/html");
        const tableElement = doc.querySelector("table");
        if(tableElement){
          // Extract headers from table
          const headers = Array.from(tableElement.querySelectorAll("thead th")).map(th => th.textContent.trim());
          const tableData = parseTableHTMLtoData(tableHTML);
          const columns = getColumnsFromHeaders(headers);

          initTable(tableData, columns);
        } else {
          document.getElementById("fuel-log-table").innerHTML = "<p style='color:red; text-align:center;'>Error: Table element not found.</p>";
        }
      } else {
        document.getElementById("fuel-log-table").innerHTML = "<p style='color:red; text-align:center;'>Error decoding table data.</p>";
      }
    } else {
      document.getElementById("fuel-log-table").innerHTML = "<p style='color:gray; text-align:center;'>No initial data provided.</p>";
    }

    // Utility: get selected rows' form IDs from Tabulator data
    function getSelectedFormIds(){
      const selectedRows = table.getSelectedData();
      // Try to find field named 'Form ID' or fallback to first column after selection
      if(!selectedRows.length) return "";
      if("Form ID" in selectedRows[0]){
        return selectedRows.map(r => r["Form ID"]).join(",");
      } else {
        // fallback to first data column field name
        const keys = Object.keys(selectedRows[0]).filter(k => !k.startsWith("_"));
        return selectedRows.map(r => r[keys[0]]).join(",");
      }
    }

    function toggleButtonsDisabled(disabled){
      document.getElementById("refreshBtn").disabled = disabled;
      document.getElementById("approveBtn").disabled = disabled;
      document.getElementById("rejectBtn").disabled = disabled;
    }

    async function handleDecision(status){
      const formIds = getSelectedFormIds();
      const statusText = document.getElementById("statusText");
      if(!formIds){
        alert("Please select at least one form.");
        return;
      }
      const webhookUrl = `https://webhooks.workato.com/webhooks/rest/b7ed69d5-2da6-44d3-befd-c64b497884e8/fuel-log-response?status=${encodeURIComponent(status)}&Reviewer=${encodeURIComponent(reviewer)}&Form_Ids=${encodeURIComponent(formIds)}`;
      statusText.textContent = `Submitting ${status}...`;
      toggleButtonsDisabled(true);
      try{
        const response = await fetch(webhookUrl, { method: 'GET' });
        if(!response.ok){
          const errorDetail = await response.text();
          throw new Error(`Webhook call failed with status ${response.status}: ${errorDetail}`);
        }
        statusText.textContent = `‚úÖ ${status} request sent successfully!`;
      }catch(error){
        console.error("Error submitting response:", error);
        statusText.textContent = `‚ùå Error: ${error.message}`;
      }finally{
        toggleButtonsDisabled(false);
      }
    }

    document.getElementById("approveBtn").onclick = () => handleDecision("Approved");
    document.getElementById("rejectBtn").onclick = () => handleDecision("Rejected");

    async function fetchRawFileContent(){
      const rawUrl = `https://raw.githubusercontent.com/sajusathish/fuel-log-review/main/RefreshedData?t=${Date.now()}`;
      const response = await fetch(rawUrl, {cache:'no-store'});
      if(!response.ok) throw new Error(`Failed fetching refreshed data: ${response.status}`);
      const text = await response.text();
      if(text.trim().length < 10) throw new Error("Refreshed data too short");
      return text;
    }

    async function refreshTable(){
      const statusText = document.getElementById("statusText");
      statusText.textContent = `Triggering refresh...`;
      statusText.insertAdjacentHTML('beforeend','<span class="loader"></span>');
      toggleButtonsDisabled(true);

      try {
        const webhookResp = await fetch("https://webhooks.workato.com/webhooks/rest/b7ed69d5-2da6-44d3-befd-c64b497884e8/refreshtable", {
          method:"GET",
          cache:"no-store"
        });
        if(!webhookResp.ok){
          const errorDetail = await webhookResp.text();
          throw new Error(`Webhook trigger failed with status ${webhookResp.status}: ${errorDetail}`);
        }

        statusText.textContent = `Fetching updated data...`;
        statusText.insertAdjacentHTML('beforeend','<span class="loader"></span>');

        // Poll once after 5s to fetch latest data from raw github file
        setTimeout(async () => {
          try {
            const newTableHTML = await fetchRawFileContent();
            const newData = parseTableHTMLtoData(newTableHTML);
            if(newData.length){
              table.replaceData(newData);
              statusText.textContent = `‚úÖ Table refreshed!`;
            } else {
              statusText.textContent = `‚ö†Ô∏è No updates found.`;
            }
          } catch(err) {
            statusText.textContent = `‚ùå Error fetching updated data: ${err.message}`;
          } finally {
            toggleButtonsDisabled(false);
          }
        }, 5000);

      } catch (err) {
        statusText.textContent = `‚ùå Refresh failed: ${err.message}`;
        toggleButtonsDisabled(false);
      }
    }

    document.getElementById("refreshBtn").onclick = refreshTable;

  </script>
</body>
</html>
