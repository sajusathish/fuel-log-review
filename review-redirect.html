<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Daily Fuel Log Review</title>
<style>
  body {
    font-family: Arial, sans-serif;
    background: #f9fafb;
    margin: 20px;
    color: #333;
  }
  h1 {
    color: #2c3e50;
  }
  table {
    width: 100%;
    border-collapse: collapse;
    margin-top: 10px;
    margin-bottom: 20px;
  }
  th, td {
    border: 1px solid #ddd;
    padding: 8px;
    text-align: left;
  }
  th {
    background-color: #007bff;
    color: white;
  }
  tr:nth-child(even){
    background-color: #f2f2f2;
  }
  button {
    padding: 12px 24px;
    margin-right: 10px;
    font-size: 16px;
    font-weight: bold;
    border: none;
    border-radius: 5px;
    cursor: pointer;
    color: white;
  }
  #approveBtn {
    background-color: #28a745;
  }
  #rejectBtn {
    background-color: #dc3545;
  }
  #message {
    margin-top: 15px;
    font-weight: bold;
  }
  #spinner {
    display: none;
    vertical-align: middle;
    margin-left: 10px;
  }
  .reviewer-info {
    margin-top: 5px;
    font-style: italic;
  }
</style>
</head>
<body>

<h1 id="pageTitle">Daily Fuel Log Review</h1>
<div class="reviewer-info" id="reviewerInfo"></div>

<div id="tableContainer">Loading table...</div>

<div>
  <button id="approveBtn">Approve</button>
  <button id="rejectBtn">Reject</button>
  <img id="spinner" src="https://i.imgur.com/llF5iyg.gif" alt="Loading..." width="24" height="24" />
</div>

<div id="message"></div>

<script>
// Get URL parameters
function getUrlParams() {
  const params = {};
  const queryString = window.location.search.substring(1);
  const vars = queryString.split('&');
  for (let v of vars) {
    let pair = v.split('=');
    params[decodeURIComponent(pair[0])] = decodeURIComponent(pair[1] || '');
  }
  return params;
}

// Decode URL-safe base64 string (replace - with + and _ with /)
function base64UrlDecode(input) {
  input = input.replace(/-/g, '+').replace(/_/g, '/');
  // Pad with '='
  while (input.length % 4) {
    input += '=';
  }
  try {
    return decodeURIComponent(escape(window.atob(input)));
  } catch (e) {
    console.error('Base64 decode error:', e);
    return null;
  }
}

const params = getUrlParams();
const reviewer = params['reviewer'] || 'Unknown Reviewer';
const encodedData = params['data'] || '';

const reviewerInfoEl = document.getElementById('reviewerInfo');
reviewerInfoEl.textContent = `Reviewer: ${reviewer}`;

// Append current date suffix to title
const pageTitle = document.getElementById('pageTitle');
const today = new Date();
const options = { year: 'numeric', month: 'short', day: 'numeric' };
pageTitle.textContent = `Daily Fuel Log Review - ${today.toLocaleDateString(undefined, options)}`;

const tableContainer = document.getElementById('tableContainer');
const messageEl = document.getElementById('message');
const spinnerEl = document.getElementById('spinner');

let decodedHtml = base64UrlDecode(encodedData);
if (!decodedHtml) {
  tableContainer.innerHTML = '<p style="color:red;">Error decoding table data.</p>';
} else {
  tableContainer.innerHTML = decodedHtml;
}

// Helper: get selected form IDs from checked checkboxes in the table
function getSelectedFormIds() {
  const checkboxes = document.querySelectorAll("input[name='selectForm']:checked");
  const ids = [];
  checkboxes.forEach(cb => ids.push(cb.value));
  return ids;
}

async function submitDecision(status) {
  const selectedFormIds = getSelectedFormIds();
  if(selectedFormIds.length === 0) {
    alert('Please select at least one form before submitting.');
    return;
  }

  messageEl.textContent = `Submitting your response: ${status}...`;
  spinnerEl.style.display = 'inline-block';

  const webhookURL = 'https://webhooks.workato.com/webhooks/rest/b7ed69d5-2da6-44d3-befd-c64b497884e8/fuel-log-response';

  const payload = {
    Status: status.toLowerCase(),
    FormIds: selectedFormIds.join(','),
    Reviewer: reviewer
  };

  console.log('Submitting to webhook:', webhookURL);
  console.log('Payload:', payload);

  try {
    const resp = await fetch(webhookURL, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(payload)
    });

    console.log('Fetch response:', resp);

    if(!resp.ok) {
      const text = await resp.text();
      console.error(`Error response text: ${text}`);
      throw new Error(`HTTP ${resp.status} - ${text}`);
    }

    messageEl.textContent = `Response "${status}" submitted successfully. Thank you, ${reviewer}.`;
  } catch (error) {
    console.error('Webhook submission error:', error);
    messageEl.textContent = `Error submitting response: ${error.message}`;
  } finally {
    spinnerEl.style.display = 'none';
  }
}

// Event listeners
document.getElementById('approveBtn').addEventListener('click', () => submitDecision('approved'));
document.getElementById('rejectBtn').addEventListener('click', () => submitDecision('rejected'));

</script>

</body>
</html>
