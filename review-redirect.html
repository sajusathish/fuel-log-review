<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8" />
  <title>Daily Fuel Log Review</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      padding: 20px;
      max-width: 900px;
      margin: auto;
    }

    #statusText {
      font-size: 1rem;
      margin-bottom: 10px;
      min-height: 24px;
    }

    .loader {
      display: inline-block;
      width: 12px;
      height: 12px;
      border: 2px solid #ccc;
      border-top: 2px solid #333;
      border-radius: 50%;
      animation: spin 1s linear infinite;
      vertical-align: middle;
    }

    @keyframes spin {
      to {
        transform: rotate(360deg);
      }
    }

    table {
      border-collapse: collapse;
      width: 100%;
      margin-top: 20px;
    }

    th,
    td {
      border: 1px solid #ccc;
      padding: 8px;
      text-align: left;
    }

    button {
      margin: 8px 5px 20px 5px;
      padding: 8px 16px;
      font-size: 14px;
      cursor: pointer;
    }

    button:disabled {
      opacity: 0.6;
      cursor: not-allowed;
    }
  </style>
</head>
<body>
  <h2>
    Daily Fuel Log Review - <span id="todayDate"></span>
  </h2>

  <div id="statusText">Waiting for refresh...</div>

  <div id="tableContainer">Loading table data...</div>

  <button id="refreshBtn">üîÑ Refresh Table</button>
  <button id="approveBtn">‚úÖ Approve</button>
  <button id="rejectBtn">‚ùå Reject</button>

  <script>
    // Utility: get URL query parameter by name
    function getQueryParam(key) {
      const url = new URL(window.location.href);
      return url.searchParams.get(key);
    }

    // Show today's date (yyyy-mm-dd)
    document.getElementById("todayDate").innerText = new Date()
      .toISOString()
      .split("T")[0];

    const statusText = document.getElementById("statusText");
    const tableContainer = document.getElementById("tableContainer");
    const refreshBtn = document.getElementById("refreshBtn");
    const approveBtn = document.getElementById("approveBtn");
    const rejectBtn = document.getElementById("rejectBtn");

    // Decode Base64 safely
    function safeBase64Decode(str) {
      try {
        // atob expects standard Base64; if URL-safe base64, replace - and _
        const base64 = str.replace(/-/g, "+").replace(/_/g, "/");
        // Fix padding
        const padded =
          base64 + "===".slice((base64.length + 3) % 4);
        return decodeURIComponent(
          escape(atob(padded))
        );
      } catch {
        return null;
      }
    }

    // Initial load of table from data param
    function loadTableFromURL() {
      const base64Data = getQueryParam("data");
      if (!base64Data) {
        tableContainer.innerHTML =
          "<p style='color:gray'>‚ö†Ô∏è No table data provided in URL.</p>";
        return false;
      }
      const htmlContent = safeBase64Decode(base64Data);
      if (!htmlContent) {
        tableContainer.innerHTML =
          "<p style='color:red'>‚ö†Ô∏è Failed to decode table data.</p>";
        return false;
      }
      tableContainer.innerHTML = htmlContent;
      return true;
    }

    // Only load table initially, do NOT start polling yet
    const initialLoadSuccess = loadTableFromURL();

    // Refresh polling flag and interval holder
    let pollingInterval = null;

    // Fetch updated table HTML from Workato webhook (replace URL if needed)
    async function fetchUpdatedTable() {
      try {
        const res = await fetch(
          "https://webhooks.workato.com/webhooks/rest/b7ed69d5-2da6-44d3-befd-c64b497884e8/refreshform",
          {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({}),
          }
        );
        if (!res.ok) throw new Error(`Status ${res.status}`);
        const text = await res.text();
        return text;
      } catch (err) {
        console.error("Error fetching updated table:", err);
        throw err;
      }
    }

    // Refresh button click handler
    refreshBtn.addEventListener("click", async () => {
      statusText.innerHTML = `<span class="loader"></span> Refreshing table...`;

      refreshBtn.disabled = true;
      approveBtn.disabled = true;
      rejectBtn.disabled = true;

      try {
        // Trigger Workato webhook to refresh data
        await fetch(
          "https://webhooks.workato.com/webhooks/rest/b7ed69d5-2da6-44d3-befd-c64b497884e8/refreshtable",
          {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({}),
          }
        );

        // Wait up to 3 seconds, polling every 500ms to get updated table
        const maxWaitMs = 3000;
        const pollIntervalMs = 500;
        let elapsed = 0;
        let updatedTable = null;

        while (elapsed < maxWaitMs) {
          try {
            updatedTable = await fetchUpdatedTable();
            if (updatedTable && updatedTable.trim().length > 0) break;
          } catch {
            // ignore error during polling
          }
          await new Promise((r) => setTimeout(r, pollIntervalMs));
          elapsed += pollIntervalMs;
        }

        if (updatedTable) {
          tableContainer.innerHTML = updatedTable;
          statusText.textContent = "‚úÖ Table refreshed.";
        } else {
          statusText.textContent =
            "‚ö†Ô∏è Timed out waiting for updated table.";
        }
      } catch (err) {
        statusText.textContent = "‚ùå Failed to refresh table.";
      } finally {
        refreshBtn.disabled = false;
        approveBtn.disabled = false;
        rejectBtn.disabled = false;
      }
    });

    // Approve / Reject handlers (same as before)
    function getSelectedFormIds() {
      return [...document.querySelectorAll("input[name='selectForm']:checked")].map(
        (el) => el.value
      );
    }

    function submitAction(action) {
      const formIds = getSelectedFormIds();
      if (formIds.length === 0) {
        statusText.innerHTML = "‚ö†Ô∏è Please select at least one form.";
        return;
      }
      const reviewer = getQueryParam("Reviewer") || "unknown";

      statusText.innerHTML = `<span class='loader'></span> Submitting ${action}...`;

      fetch(
        "https://webhooks.workato.com/webhooks/rest/b7ed69d5-2da6-44d3-befd-c64b497884e8/fuel-log-response?status=" +
          action +
          "&Reviewer=" +
          reviewer +
          "&Form_Ids=" +
          encodeURIComponent(formIds.join(",")),
        {
          method: "GET",
        }
      )
        .then((res) => res.text())
        .then((text) => {
          statusText.innerHTML = "‚úÖ Response submitted: " + text;
        })
        .catch((err) => {
          console.error("Submit error", err);
          statusText.innerHTML = "‚ùå Failed to submit response.";
        });
    }

    approveBtn.onclick = () => submitAction("Approved");
    rejectBtn.onclick = () => submitAction("Rejected");
  </script>
</body>
</html>
