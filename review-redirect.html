<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Daily Fuel Log Review</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 0;
      padding: 1em;
      background: #f7f7f7;
    }
    #statusMessage {
      padding: 0.5em;
      margin-bottom: 1em;
      background: #eef;
      border-left: 4px solid #77f;
      font-weight: bold;
    }
    table {
      border-collapse: collapse;
      width: 90vw;
      margin: auto;
      background: white;
    }
    th, td {
      border: 1px solid #ccc;
      padding: 0.5em;
      text-align: left;
    }
    th {
      background: #eee;
    }
  </style>
</head>
<body>

<div id="statusMessage">Loading table…</div>
<div id="tableContainer"></div>

<script>
  const repoOwner = "sajusathish";
  const repoName = "fuel-log-review";
  const filePath = "review-redirect.html";
  const branch = "main";
  const fileUrl = `https://raw.githubusercontent.com/${repoOwner}/${repoName}/${branch}/${filePath}`;

  const urlParams = new URLSearchParams(window.location.search);
  const dataEncoded = urlParams.get("data");
  let initialTableHTML = null;

  function base64UrlDecode(base64Url) {
    const base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/');
    const decoded = atob(base64);
    return decoded;
  }

  function extractFormIdSetFromTableHTML(html) {
    const temp = document.createElement('div');
    temp.innerHTML = html;
    const formIds = new Set();
    const rows = temp.querySelectorAll("table tbody tr");
    rows.forEach(row => {
      const formIdCell = row.children[1]; // adjust index if needed
      if (formIdCell) {
        const id = formIdCell.textContent.trim();
        if (id) formIds.add(id);
      }
    });
    return formIds;
  }

  function pollForUpdate(initialFormIds, interval = 7000) {
    console.log("[Poll] Started polling GitHub every", interval, "ms");

    return new Promise((resolve) => {
      const check = async () => {
        console.log("[Poll] Checking for updates…");
        const response = await fetch(fileUrl + "?cacheBust=" + Date.now());
        const newText = await response.text();

        const newFormIds = extractFormIdSetFromTableHTML(newText);
        console.log("[Poll] Old Form IDs:", [...initialFormIds]);
        console.log("[Poll] New Form IDs:", [...newFormIds]);

        const hasChange =
          initialFormIds.size !== newFormIds.size ||
          [...newFormIds].some(id => !initialFormIds.has(id));

        if (hasChange) {
          document.getElementById("statusMessage").textContent = "✅ Update found!";
          document.getElementById("tableContainer").innerHTML = newText;
          resolve();
        } else {
          console.log("[Poll] No difference found, continuing…");
          setTimeout(check, interval);
        }
      };

      setTimeout(check, interval);
    });
  }

  async function init() {
    if (dataEncoded) {
      const decodedHTML = base64UrlDecode(dataEncoded);
      document.getElementById("tableContainer").innerHTML = decodedHTML;
      initialTableHTML = decodedHTML;
      document.getElementById("statusMessage").textContent = "✅ Table loaded. Polling for updates…";

      const initialFormIds = extractFormIdSetFromTableHTML(initialTableHTML);
      await pollForUpdate(initialFormIds);
    } else {
      document.getElementById("statusMessage").textContent = "❌ No data provided in URL.";
    }
  }

  init();
</script>

</body>
</html>
