<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Daily Fuel Log Review</title>
  <style>/* your existing styles unchanged */</style>
</head>
<body>
  <h3>Daily Fuel Log Review ‚Äì <span id="todayDate"></span></h3>
  <div id="tableContainer"><p style="text-align:center; color:#666;">Loading table data‚Ä¶</p></div>
  <div class="buttons">
    <button class="refresh" id="refreshBtn">üîÑ Refresh Table</button>
    <button class="approve" id="approveBtn">‚úÖ Approve</button>
    <button class="reject" id="rejectBtn">‚ùå Reject</button>
  </div>
  <div id="statusText" aria-live="polite" role="status"></div>

  <script>
    // decode & UI helpers same as before...

    // Extract Form ID set
    function extractFormIdSetFromTableHTML(html) {
      const wrapper = document.createElement('div'); wrapper.innerHTML = html;
      const table = wrapper.querySelector('table');
      const headers = table ? Array.from(table.querySelectorAll('thead th')) : [];
      const formIdIndex = headers.findIndex(th => th.textContent.trim().toLowerCase() === 'form id');
      console.log('[extract] formIdIndex:', formIdIndex);
      const ids = new Set();
      if (formIdIndex >= 0 && table) {
        table.querySelectorAll('tbody tr').forEach(row => {
          const cells = row.querySelectorAll('td');
          if (cells[formIdIndex]) ids.add(cells[formIdIndex].textContent.trim());
        });
      }
      console.log('[extract] FormIds extracted:', Array.from(ids));
      return ids;
    }

    // Compare sets
    function areFormIdSetsDifferent(a,b) {
      if (a.size !== b.size) return true;
      for (let x of a) if (!b.has(x)) return true;
      return false;
    }

    // poll logic
    async function pollForUpdate(initialTimestamp) {
      console.log('[Poll] Started polling GitHub every 7000 ms');
      const statusText = document.getElementById('statusText');
      let attempts = 0, polling;
      return new Promise(resolve => {
        polling = setInterval(async () => {
          attempts++;
          console.log(`[poll] attempt ${attempts}`);
          try {
            const commitsUrl = 'https://api.github.com/repos/sajusathish/fuel-log-review/commits?path=RefreshedData&page=1&per_page=1';
            const resp = await fetch(commitsUrl, {cache:'no-store'});
            const json = await resp.json();
            const latestTimestamp = json[0]?.commit?.author?.date;
            console.log('[poll] latestTimestamp', latestTimestamp);
            if (latestTimestamp !== initialTimestamp || attempts >= 10) {
              clearInterval(polling);
              const newHtml = await fetch(`https://raw.githubusercontent.com/sajusathish/fuel-log-review/main/RefreshedData?t=${Date.now()}`, {cache:'no-store'});
              const newTableHtml = await newHtml.text();
              const currentHtml = document.getElementById('tableContainer').innerHTML;
              console.log('[poll] currentHtml:', currentHtml);
              console.log('[poll] newHtml:', newTableHtml);
              const oldSet = extractFormIdSetFromTableHTML(currentHtml);
              const newSet = extractFormIdSetFromTableHTML(newTableHtml);
              document.getElementById('tableContainer').innerHTML = newTableHtml;
              addSelectAllControl(); addColumnResizers();
              if (latestTimestamp !== initialTimestamp && areFormIdSetsDifferent(oldSet, newSet)) {
                console.log('[poll] sets differ ‚Üí refresh yes');
                statusText.textContent = `‚úÖ Table refreshed! Last update on ${toHSTString(latestTimestamp)}`;
                resolve(true);
              } else {
                console.log('[poll] sets identical or no timestamp change');
                statusText.textContent = `‚ö†Ô∏è No updates found. Last update on ${toHSTString(latestTimestamp)}`;
                resolve(false);
              }
              toggleButtonsDisabled(false);
            }
          } catch (e) {
            clearInterval(polling);
            console.error('[poll] error', e);
            statusText.textContent = `‚ùå Polling error: ${e.message}`;
            toggleButtonsDisabled(false);
            resolve(false);
          }
        }, 7000);
      });
    }

    async function refreshTable() {
      toggleButtonsDisabled(true);
      const statusText = document.getElementById('statusText');
      statusText.textContent = 'Triggering refresh‚Ä¶';
      statusText.insertAdjacentHTML('beforeend','<span class="loader"></span>');
      try {
        await fetch('https://webhooks.workato.com/webhooks/rest/.../refreshtable', {method:'GET', cache:'no-store'});
        const resp = await fetch('https://api.github.com/repos/sajusathish/fuel-log-review/commits?path=RefreshedData&page=1&per_page=1', {cache:'no-store'});
        const json = await resp.json();
        const currentTimestamp = json[0]?.commit?.author?.date;
        console.log('[refresh] initial timestamp', currentTimestamp);
        statusText.textContent = 'Waiting for updated data‚Ä¶';
        statusText.insertAdjacentHTML('beforeend','<span class="loader"></span>');
        await pollForUpdate(currentTimestamp);
      } catch (e) {
        console.error('[refresh] error', e);
        statusText.textContent = `‚ùå Refresh failed: ${e.message}`;
        toggleButtonsDisabled(false);
      }
    }

    document.getElementById('refreshBtn').onclick = refreshTable;
    // attach approve/reject, addSelectAllControl, addColumnResizers, toHSTString remain same
  </script>
</body>
</html>
