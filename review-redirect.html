<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Daily Fuel Log Review</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      padding: 20px;
    }

    #statusText {
      font-size: 1rem;
      margin-bottom: 10px;
    }

    .loader {
      display: inline-block;
      width: 12px;
      height: 12px;
      border: 2px solid #ccc;
      border-top: 2px solid #333;
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    table {
      border-collapse: collapse;
      width: 100%;
      margin-top: 20px;
    }

    th, td {
      border: 1px solid #ccc;
      padding: 8px;
      text-align: left;
    }

    button {
      margin: 8px 5px;
      padding: 8px 16px;
      font-size: 14px;
    }
  </style>
</head>
<body>
  <h2>Daily Fuel Log Review - <span id="todayDate"></span></h2>

  <div id="statusText">Waiting for refresh...</div>

  <div id="tableContainer">Loading...</div>

  <button id="refreshBtn">üîÑ Refresh Table</button>
  <button id="approveBtn">‚úÖ Approve</button>
  <button id="rejectBtn">‚ùå Reject</button>

  <script>
    function getQueryParam(key) {
      const url = new URL(window.location.href);
      return url.searchParams.get(key);
    }

    document.getElementById("todayDate").innerText = new Date().toISOString().split("T")[0];

    const statusText = document.getElementById("statusText");
    const tableContainer = document.getElementById("tableContainer");
    const refreshBtn = document.getElementById("refreshBtn");
    const approveBtn = document.getElementById("approveBtn");
    const rejectBtn = document.getElementById("rejectBtn");

    const base64Data = getQueryParam("data");
    if (base64Data) {
      try {
        const htmlContent = atob(base64Data);
        tableContainer.innerHTML = htmlContent;
      } catch (e) {
        tableContainer.innerHTML = "<p style='color:red'>‚ö†Ô∏è Failed to decode data.</p>";
      }
    } else {
      tableContainer.innerHTML = "<p style='color:gray'>‚ö†Ô∏è No data provided.</p>";
    }

    refreshBtn.onclick = () => {
      const formIds = [...document.querySelectorAll("input[name='selectForm']:checked")].map(i => i.value);
      if (formIds.length === 0) {
        statusText.innerHTML = "‚ö†Ô∏è Please select at least one form.";
        return;
      }

      statusText.innerHTML = "<span class='loader'></span> Refreshing...";
      fetch("https://webhooks.workato.com/webhooks/rest/b7ed69d5-2da6-44d3-befd-c64b497884e8/refreshform", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ form_ids: formIds })
      })
      .then(res => res.json())
      .then(data => {
        statusText.innerHTML = "‚úÖ Refreshed. Please reload to see updated table.";
        console.log("Refresh response:", data);
      })
      .catch(err => {
        console.error("Refresh error", err);
        statusText.innerHTML = "‚ùå Failed to refresh.";
      });
    };

    function submitAction(action) {
      const formIds = [...document.querySelectorAll("input[name='selectForm']:checked")].map(i => i.value);
      const reviewer = getQueryParam("Reviewer") || "unknown";
      if (formIds.length === 0) {
        statusText.innerHTML = "‚ö†Ô∏è Please select at least one form.";
        return;
      }

      statusText.innerHTML = `<span class='loader'></span> Submitting ${action}...`;

      fetch("https://webhooks.workato.com/webhooks/rest/b7ed69d5-2da6-44d3-befd-c64b497884e8/fuel-log-response?status=" + action + "&Reviewer=" + reviewer + "&Form_Ids=" + encodeURIComponent(formIds.join(",")), {
        method: "GET"
      })
      .then(res => res.text())
      .then(text => {
        statusText.innerHTML = "‚úÖ Response submitted: " + text;
      })
      .catch(err => {
        console.error("Submit error", err);
        statusText.innerHTML = "‚ùå Failed to submit response.";
      });
    }

    approveBtn.onclick = () => submitAction("Approved");
    rejectBtn.onclick = () => submitAction("Rejected");
  </script>
</body>
</html>
