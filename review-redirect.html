<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Daily Fuel Log Review</title>

  <!-- Tabulator CSS -->
  <link href="https://unpkg.com/tabulator-tables@5.5.0/dist/css/tabulator_modern.min.css" rel="stylesheet">

  <style>
    html, body {
      margin: 0; padding: 0; 
      width: 100%; 
      overflow-x: hidden;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: #f9fafb;
      color: #222;
      height: 100vh;
      display: flex;
      flex-direction: column;
      align-items: center;
    }
    h3 {
      align-self: stretch;
      margin: 20px;
      font-weight: 700;
      color: #2c3e50;
      font-size: 1.8rem;
      user-select: none;
    }
    #fuel-log-table {
      border: 2px solid blue;
      width: 95%;
      box-sizing: border-box;
    }
    .buttons {
      margin: 15px 20px 30px;
      display: flex;
      justify-content: center;
      gap: 20px;
      flex-wrap: wrap;
      width: 100vw;
    }
    button {
      cursor: pointer;
      border: none;
      height: 40px;
      width: 200px;        
      border-radius: 0px;
      font-size: 16px;
      font-weight: 600;
      color: white;
      background-color: #2980b9;
      box-shadow: 0 4px 8px rgb(0 0 0 / 0.15);
      transition: background-color 0.3s ease, box-shadow 0.2s ease, transform 0.15s ease;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      user-select: none;
    }
    button:hover:not(:disabled) {
      box-shadow: 0 6px 15px rgb(0 0 0 / 0.25);
      transform: translateY(-2px);
    }
    button:disabled {
      cursor: not-allowed;
      opacity: 0.6;
      box-shadow: none;
      transform: none;
    }
    button.approve {
      background-color: #27ae60;
    }
    button.approve:hover:not(:disabled) {
      background-color: #1e8449;
    }
    button.reject {
      background-color: #c0392b;
    }
    button.reject:hover:not(:disabled) {
      background-color: #922b21;
    }
    #statusText {
      margin: 0 20px 30px;
      font-weight: 600;
      color: #34495e;
      user-select: none;
      min-height: 24px;
      width: 100vw;
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 8px;
    }
    .loader {
      display: inline-block;
      width: 18px;
      height: 18px;
      border: 3px solid rgba(0,0,0,0.2);
      border-top: 3px solid #34495e;
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
      vertical-align: middle;
    }
    @keyframes spin {
      0% { transform: rotate(0deg);}
      100% { transform: rotate(360deg);}
    }
  </style>
</head>
<body>

  <h3>Daily Fuel Log Review - <span id="todayDate"></span></h3>

  <div id="fuel-log-table"></div>

  <div class="buttons">
    <button id="refreshBtn" aria-label="Refresh Table">üîÑ Refresh Table</button>
    <button id="approveBtn" class="approve" aria-label="Approve Selected">‚úÖ Approve</button>
    <button id="rejectBtn" class="reject" aria-label="Reject Selected">‚ùå Reject</button>
  </div>

  <div id="statusText" aria-live="polite" role="status"></div>

  <script src="https://unpkg.com/tabulator-tables@5.5.0/dist/js/tabulator.min.js"></script>

  <script>
    document.getElementById("todayDate").textContent = new Date().toISOString().split("T")[0];

    function base64UrlDecode(input) {
      try {
        const base64 = input.replace(/-/g, '+').replace(/_/g, '/');
        const decoded = atob(base64);
        return decodeURIComponent(escape(decoded));
      } catch(e) {
        console.error("Decode error", e);
        return null;
      }
    }

    function parseTableHTMLtoData(html){
      const parser = new DOMParser();
      const doc = parser.parseFromString(html, "text/html");
      const table = doc.querySelector("table");
      if(!table) return [];

      const headers = Array.from(table.querySelectorAll("thead th")).map(th => th.textContent.trim());
      const rows = Array.from(table.querySelectorAll("tbody tr"));

      return rows.map(row => {
        const cells = Array.from(row.querySelectorAll("td"));
        let obj = {};
        cells.forEach((cell, i) => {
          obj[headers[i] || `col${i}`] = cell.textContent.trim();
        });
        return obj;
      });
    }

    function getColumnsFromHeaders(headers){
      const filteredHeaders = headers.filter(hdr => hdr.toLowerCase() !== 'select');
      return [{
        formatter: "rowSelection",
        titleFormatter: "rowSelection",
        hozAlign: "center",
        headerSort: false,
        width: 50,
        frozen: true
      }].concat(filteredHeaders.map(hdr => ({
        title: hdr,
        field: hdr,
        headerFilter: "input",
        headerSort: true,
        resizable: true,
        hozAlign: "left",
        tooltip: true,
        visible: hdr === "Form ID" ? false : true
      })));
    }

    let table;
    const params = new URLSearchParams(window.location.search);
    const dataEncoded = params.get('data');
    const reviewer = params.get('reviewer') || 'unknown@domain.com';

    if(dataEncoded){
      const tableHTML = base64UrlDecode(dataEncoded);
      if(tableHTML){
        const parser = new DOMParser();
        const doc = parser.parseFromString(tableHTML, "text/html");
        const tableElement = doc.querySelector("table");
        if(tableElement){
          const headers = Array.from(tableElement.querySelectorAll("thead th")).map(th => th.textContent.trim());
          const tableData = parseTableHTMLtoData(tableHTML);
          const columns = getColumnsFromHeaders(headers);
          table = new Tabulator("#fuel-log-table", {
            data: tableData,
            layout: "fitDataStretch",
            movableColumns: true,
            resizableColumns: true,
            columns: columns,
            selectable: true,
            selectableCheck: () => true,
            rowClick: false,
            pagination: false,
            initialSort: [{ column: columns[1].field, dir: "asc" }]
          });
        } else {
          document.getElementById("fuel-log-table").innerHTML = "<p style='color:red; text-align:center;'>No table found in data.</p>";
        }
      } else {
        document.getElementById("fuel-log-table").innerHTML = "<p style='color:red; text-align:center;'>Failed to decode data.</p>";
      }
    } else {
      document.getElementById("fuel-log-table").innerHTML = "<p style='color:gray; text-align:center;'>No initial data provided.</p>";
    }

    function getSelectedFormIds(){
      const selectedRows = table.getSelectedData();
      if(!selectedRows.length) return "";
      if("Form ID" in selectedRows[0]){
        return selectedRows.map(r => r["Form ID"]).join(",");
      }
      const keys = Object.keys(selectedRows[0]);
      return selectedRows.map(r => r[keys[0]]).join(",");
    }

    function toggleButtonsDisabled(disabled){
      document.getElementById("refreshBtn").disabled = disabled;
      document.getElementById("approveBtn").disabled = disabled;
      document.getElementById("rejectBtn").disabled = disabled;
    }

    async function handleDecision(status){
      const formIds = getSelectedFormIds();
      const statusText = document.getElementById("statusText");
      if(!formIds){
        alert("Please select at least one form.");
        return;
      }
      const webhookUrl = `https://webhooks.workato.com/webhooks/rest/b7ed69d5-2da6-44d3-befd-c64b497884e8/fuel-log-response?status=${encodeURIComponent(status)}&Reviewer=${encodeURIComponent(reviewer)}&Form_Ids=${encodeURIComponent(formIds)}`;
      statusText.textContent = `Submitting ${status}...`;
      toggleButtonsDisabled(true);
      try {
        const response = await fetch(webhookUrl, { method: 'GET' });
        if(!response.ok){
          const errText = await response.text();
          throw new Error(`Webhook call failed: ${errText}`);
        }
        statusText.textContent = `‚úÖ ${status} sent successfully!`;
      } catch(e) {
        statusText.textContent = `‚ùå Error: ${e.message}`;
      } finally {
        toggleButtonsDisabled(false);
      }
    }

    document.getElementById("approveBtn").onclick = () => handleDecision("Approved");
    document.getElementById("rejectBtn").onclick = () => handleDecision("Rejected");

    async function fetchRawFileContent(){
      const url = `https://raw.githubusercontent.com/sajusathish/fuel-log-review/main/RefreshedData?t=${Date.now()}`;
      const resp = await fetch(url, {cache:'no-store'});
      if(!resp.ok) throw new Error(`Fetch failed: ${resp.status}`);
      const txt = await resp.text();
      if(txt.trim().length < 10) throw new Error("Refreshed data too short");
      return txt;
    }

    async function refreshTable(){
  const statusText = document.getElementById("statusText");
  statusText.textContent = `Triggering refresh...`;
  statusText.insertAdjacentHTML('beforeend', '<span class="loader"></span>');
  toggleButtonsDisabled(true);

  try {
    const webhookResp = await fetch("https://webhooks.workato.com/webhooks/rest/b7ed69d5-2da6-44d3-befd-c64b497884e8/refreshtable", {method:"GET",cache:"no-store"});
    if(!webhookResp.ok){
      const errTxt = await webhookResp.text();
      throw new Error(`Webhook trigger failed: ${errTxt}`);
    }

    statusText.textContent = `Fetching updated data...`;
    statusText.insertAdjacentHTML('beforeend', '<span class="loader"></span>');

    setTimeout(async () => {
      try {
        const newTableHTML = await fetchRawFileContent();
        const newData = parseTableHTMLtoData(newTableHTML);

        const newFormIds = newData.map(row => row["Form ID"]).sort();
        const currentFormIds = table.getData().map(row => row["Form ID"]).sort();

        const hasChanged = newFormIds.length !== currentFormIds.length ||
                           newFormIds.some((id, idx) => id !== currentFormIds[idx]);

        // Hawaii Standard Time display
        const now = new Date();
        const timeString = now.toLocaleString("en-US", {
          timeZone: "Pacific/Honolulu",
          year: 'numeric',
          month: 'short',
          day: 'numeric',
          hour: '2-digit',
          minute: '2-digit',
          second: '2-digit',
          timeZoneName: 'short'
        });

        if(hasChanged){
          table.replaceData(newData);
          statusText.textContent = `‚úÖ Table refreshed! (${timeString})`;
        } else {
          statusText.textContent = `‚ö†Ô∏è No updates found. (${timeString})`;
        }

      } catch(err) {
        statusText.textContent = `‚ùå Error fetching updated data: ${err.message}`;
      } finally {
        toggleButtonsDisabled(false);
      }
    }, 5000);

  } catch(e) {
    statusText.textContent = `‚ùå Refresh failed: ${e.message}`;
    toggleButtonsDisabled(false);
  }
}


    document.getElementById("refreshBtn").onclick = refreshTable;

  </script>
</body>
</html>
