<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Daily Fuel Log Review</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      padding: 30px;
      background-color: #f4f4f4;
    }
    h1 {
      color: #333;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 20px;
      background-color: #fff;
    }
    th, td {
      border: 1px solid #ccc;
      padding: 12px;
      text-align: left;
    }
    th {
      background-color: #007bff;
      color: white;
    }
    tr:nth-child(even) {
      background-color: #f9f9f9;
    }
    .buttons {
      margin-top: 20px;
    }
    button {
      padding: 10px 20px;
      margin-right: 15px;
      font-size: 16px;
      border: none;
      border-radius: 6px;
      cursor: pointer;
    }
    #approve {
      background-color: #28a745;
      color: white;
    }
    #reject {
      background-color: #dc3545;
      color: white;
    }
  </style>
</head>
<body>
  <h1 id="page-title">Daily Fuel Log Review</h1>
  <div id="table-container">Loading...</div>

  <div class="buttons" id="action-buttons" style="display: none;">
    <button id="approve">✅ Approve</button>
    <button id="reject">❌ Reject</button>
  </div>

  <script>
    function base64DecodeUnicode(str) {
      try {
        return decodeURIComponent(
          atob(str.replace(/-/g, '+').replace(/_/g, '/'))
            .split('')
            .map(function(c) {
              return '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2);
            })
            .join('')
        );
      } catch (e) {
        console.error("Decode error:", e);
        return null;
      }
    }

    function getQueryParam(name) {
      const url = new URL(window.location.href);
      return url.searchParams.get(name);
    }

    function extractSelectedFormIds() {
      const checkboxes = document.querySelectorAll("input[name='selectForm']:checked");
      return Array.from(checkboxes).map(cb => cb.value);
    }

    function handleDecision(status) {
      const formIds = extractSelectedFormIds();
      const reviewer = getQueryParam("reviewer");

      if (!formIds.length) {
        alert("Please select at least one row to proceed.");
        return;
      }

      const url = new URL("https://webhooks.workato.com/webhooks/rest/b7ed69d5-2da6-44d3-befd-c64b497884e8/fuel-log-response");
      url.searchParams.append("status", status);
      url.searchParams.append("Reviewer", reviewer);
      url.searchParams.append("Form_Ids", formIds.join(","));

      fetch(url.toString(), {
        method: "GET"
      })
      .then(response => {
        if (!response.ok) throw new Error("Network response was not ok");
        alert(`Successfully ${status.toLowerCase()} the selected form(s).`);
      })
      .catch(error => {
        alert("Error submitting response: " + error);
      });
    }

    document.getElementById("approve").onclick = () => handleDecision("Approved");
    document.getElementById("reject").onclick = () => handleDecision("Rejected");

    (function init() {
      const reviewer = getQueryParam("reviewer");
      const encodedData = getQueryParam("data");

      // Update title with today's date
      const today = new Date();
      const formatted = today.toISOString().split("T")[0];
      document.getElementById("page-title").innerText += ` – ${formatted}`;

      if (!encodedData) {
        document.getElementById("table-container").innerText = "No table data found in URL.";
        return;
      }

      const decoded = base64DecodeUnicode(encodedData);
      if (!decoded) {
        document.getElementById("table-container").innerText = "Error decoding table data.";
        return;
      }

      const parser = new DOMParser();
      const doc = parser.parseFromString(decoded, "text/html");
      const table = doc.querySelector("table");

      if (!table) {
        document.getElementById("table-container").innerText = "Invalid table format.";
        return;
      }

      const rows = table.querySelectorAll("tbody tr");
      rows.forEach(row => {
        const cell = row.insertCell(0);
        const input = document.createElement("input");
        input.type = "checkbox";
        input.name = "selectForm";
        input.value = row.children[1]?.innerText.trim(); // Form ID
        cell.appendChild(input);
      });

      const headerRow = table.querySelector("thead tr");
      const th = document.createElement("th");
      th.innerText = "Select";
      headerRow.insertBefore(th, headerRow.firstChild);

      document.getElementById("table-container").innerHTML = "";
      document.getElementById("table-container").appendChild(table);
      document.getElementById("action-buttons").style.display = "block";
    })();
  </script>
</body>
</html>
