<!DOCTYPE html>
<html>
<head>
  <title>Processing...</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      text-align: center;
      padding-top: 50px;
      background: #f8f8f8;
    }
    .spinner {
      border: 6px solid #ccc;
      border-top: 6px solid #007bff;
      border-radius: 50%;
      width: 40px;
      height: 40px;
      animation: spin 1s linear infinite;
      margin: 20px auto;
    }
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    #table-container {
      max-width: 90%;
      margin: 20px auto;
      text-align: left;
    }
  </style>
</head>
<body>

  <h2 id="message">Loading...</h2>
  <div id="spinner" class="spinner"></div>
  <div id="table-container" style="display:none;"></div>

  <script>
    function getParam(name) {
      return new URLSearchParams(window.location.search).get(name);
    }

    function base64DecodeUnicode(str) {
      try {
        console.log("Raw input string:", str);

        let cleaned = str.replace(/\s+/g, '');

        let prev;
        do {
          prev = cleaned;
          cleaned = decodeURIComponent(cleaned);
        } while (cleaned !== prev);

        console.log("After full decodeURIComponent:", cleaned);

        cleaned = cleaned.replace(/-/g, '+').replace(/_/g, '/');

        while (cleaned.length % 4 !== 0) {
          cleaned += '=';
        }

        console.log("Cleaned base64 string for atob():", cleaned);

        const binary = atob(cleaned);

        const decoded = decodeURIComponent(
          Array.prototype.map.call(binary, c => {
            return '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2);
          }).join('')
        );

        console.log("Final decoded HTML:", decoded);
        return decoded;
      } catch(e) {
        console.error("Decode error:", e);
        return null;
      }
    }

    const data = getParam('data');
    const formId = getParam('formId');
    const status = getParam('status');
    const reviewer = getParam('reviewer');

    if (data) {
      const decodedHtml = base64DecodeUnicode(data);
      if (decodedHtml) {
        document.getElementById('message').innerText = 'Daily Fuel Log Review';
        document.getElementById('spinner').style.display = 'none';
        const container = document.getElementById('table-container');
        container.style.display = 'block';
        container.innerHTML = decodedHtml;
      } else {
        document.getElementById('message').innerText = 'Error decoding table data.';
        document.getElementById('spinner').style.display = 'none';
      }
    }
    else if (formId && status && reviewer) {
      document.getElementById('message').innerText = 'Submitting your response...';

      const webhookURL = `https://webhooks.workato.com/webhooks/rest/b7ed69d5-2da6-44d3-befd-c64b497884e8/fuel-log-response?status=${encodeURIComponent(status)}&Reviewer=${encodeURIComponent(reviewer)}&FormIds=${encodeURIComponent(formId)}`;

      const accURL = `https://acc.autodesk.com/build/forms/projects/f94d12c8-f951-45a5-b1c3-8419a37750fb/field-reports/904f2c31-f161-4f91-a20a-774e0df6d933/reports/${encodeURIComponent(formId)}`;

      fetch(webhookURL)
        .catch(err => console.error('Webhook failed:', err))
        .finally(() => window.location.href = accURL);
    }
    else {
      document.getElementById('message').innerText = 'Missing parameters. Please check your link.';
      document.getElementById('spinner').style.display = 'none';
    }
  </script>
</body>
</html>
