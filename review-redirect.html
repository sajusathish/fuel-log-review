<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Daily Fuel Log Review</title>
  <style>
    body { font-family: Arial, sans-serif; padding: 20px; }
    #tableContainer table { border-collapse: collapse; width: 100%; }
    #tableContainer th, td { border: 1px solid #ccc; padding: 8px; text-align: left; }
    #statusText { margin-top: 10px; font-weight: bold; }
    #buttons { margin-top: 20px; }
    button { margin-right: 10px; padding: 8px 12px; }
  </style>
</head>
<body>
  <h2 id="title"></h2>
  <div id="statusText">Waiting for refresh...</div>
  <div id="tableContainer">Loading table...</div>

  <div id="buttons">
    <button onclick="refreshTable()">üîÑ Refresh</button>
    <button>‚úÖ Approve</button>
    <button>‚ùå Reject</button>
  </div>

  <script>
    const githubContentURL = "https://raw.githubusercontent.com/sajusathish/fuel-log-review/main/RefreshedData";
    const githubTimestampURL = "https://api.github.com/repos/sajusathish/fuel-log-review/commits?path=RefreshedData&page=1&per_page=1";
    let lastTimestamp = "";

    document.getElementById("title").textContent = "Daily Fuel Log Review - " + new Date().toISOString().split("T")[0];

    // Load initial table from URL parameter
    const urlParams = new URLSearchParams(window.location.search);
    const base64Data = urlParams.get("data");
    if (base64Data) {
      try {
        const html = atob(base64Data);
        const parser = new DOMParser();
        const doc = parser.parseFromString(html, "text/html");
        const table = doc.querySelector("table");
        document.getElementById("tableContainer").innerHTML = "";
        if (table) {
          document.getElementById("tableContainer").appendChild(table);
          document.getElementById("statusText").textContent = "‚úÖ Table loaded from URL.";
        } else {
          document.getElementById("tableContainer").innerHTML = "<p>‚ö†Ô∏è No table found in URL data.</p>";
        }
      } catch (e) {
        document.getElementById("tableContainer").innerHTML = "<p>‚ö†Ô∏è Failed to decode base64 HTML.</p>";
      }
    } else {
      document.getElementById("tableContainer").innerHTML = "<p>‚ö†Ô∏è No table data in URL.</p>";
    }

    // Called on Refresh button click
    function refreshTable() {
      document.getElementById("statusText").textContent = "‚è≥ Fetching latest update time...";
      const refreshStartTime = Date.now();

      fetch(githubTimestampURL)
        .then(res => res.json())
        .then(data => {
          if (!Array.isArray(data) || data.length === 0) throw new Error("No commit data found");
          lastTimestamp = data[0].commit.committer.date;
          document.getElementById("statusText").textContent = "üîÑ Polling for updated data...";
          pollForUpdate(lastTimestamp, refreshStartTime);
        })
        .catch(err => {
          console.error("Failed to get commit timestamp", err);
          document.getElementById("statusText").textContent = "‚ö†Ô∏è Failed to fetch commit timestamp.";
        });
    }

    function pollForUpdate(originalTimestamp, startTime) {
      const interval = setInterval(() => {
        console.log("‚è≥ Checking for update...");

        fetch(githubTimestampURL)
          .then(res => res.json())
          .then(data => {
            if (!Array.isArray(data) || data.length === 0) throw new Error("No commit data found");
            const newTimestamp = data[0].commit.committer.date;

            if (newTimestamp !== originalTimestamp) {
              console.log("‚úÖ New update detected!");
              clearInterval(interval);
              loadLatestTable(newTimestamp);
            } else if (Date.now() - startTime > 30000) {
              clearInterval(interval);
              const hstTime = convertToHST(originalTimestamp);
              document.getElementById("statusText").textContent = `‚ö†Ô∏è No update in 30s. Last updated on ${hstTime}`;
            }
          })
          .catch(err => {
            console.error("Polling error:", err);
            clearInterval(interval);
            document.getElementById("statusText").textContent = "‚ö†Ô∏è Error while polling for updates.";
          });
      }, 3000);
    }

    function loadLatestTable(commitTime) {
      fetch(githubContentURL)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const doc = parser.parseFromString(html, "text/html");
          const table = doc.querySelector("table");
          document.getElementById("tableContainer").innerHTML = "";
          if (table) {
            document.getElementById("tableContainer").appendChild(table);
            const hstTime = convertToHST(commitTime);
            document.getElementById("statusText").textContent = `‚úÖ Table refreshed! Last update on ${hstTime}`;
          } else {
            document.getElementById("tableContainer").innerHTML = "<p>‚ö†Ô∏è No table found in GitHub data.</p>";
          }
        })
        .catch(err => {
          console.error("Error loading GitHub HTML:", err);
          document.getElementById("statusText").textContent = "‚ö†Ô∏è Failed to load GitHub content.";
        });
    }

    function convertToHST(utcString) {
      try {
        const utcDate = new Date(utcString);
        const options = {
          timeZone: 'Pacific/Honolulu',
          hour12: false,
          year: 'numeric',
          month: '2-digit',
          day: '2-digit',
          hour: '2-digit',
          minute: '2-digit',
          second: '2-digit'
        };
        return new Intl.DateTimeFormat('en-US', options).format(utcDate) + " HST";
      } catch (e) {
        return utcString + " UTC";
      }
    }
  </script>
</body>
</html>
