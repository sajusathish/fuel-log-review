<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Daily Fuel Log Review</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      padding: 20px;
    }

    #statusText {
      font-size: 1rem;
      margin-bottom: 10px;
    }

    .loader {
      display: inline-block;
      width: 12px;
      height: 12px;
      border: 2px solid #ccc;
      border-top: 2px solid #333;
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    table {
      border-collapse: collapse;
      width: 100%;
      margin-top: 20px;
    }

    th, td {
      border: 1px solid #ccc;
      padding: 8px;
      text-align: left;
    }

    button {
      margin: 8px 5px;
      padding: 8px 16px;
      font-size: 14px;
    }
  </style>
</head>
<body>
  <h2>Daily Fuel Log Review - <span id="todayDate"></span></h2>

  <div id="statusText">Waiting for refresh...</div>
  <div id="tableContainer">Loading...</div>

  <button id="refreshBtn">üîÑ Refresh Table</button>
  <button id="approveBtn">‚úÖ Approve</button>
  <button id="rejectBtn">‚ùå Reject</button>

  <script>
    function getQueryParam(key) {
      const url = new URL(window.location.href);
      return url.searchParams.get(key);
    }

    document.getElementById("todayDate").innerText = new Date().toISOString().split("T")[0];

    const statusText = document.getElementById("statusText");
    const tableContainer = document.getElementById("tableContainer");
    const refreshBtn = document.getElementById("refreshBtn");
    const approveBtn = document.getElementById("approveBtn");
    const rejectBtn = document.getElementById("rejectBtn");

    const base64Data = getQueryParam("data");
    if (base64Data) {
      try {
        const htmlContent = atob(base64Data);
        tableContainer.innerHTML = htmlContent;
      } catch (e) {
        tableContainer.innerHTML = "<p style='color:red'>‚ö†Ô∏è Failed to decode data.</p>";
      }
    } else {
      tableContainer.innerHTML = "<p style='color:gray'>‚ö†Ô∏è No data provided.</p>";
    }

    function parseUpdatedTimestamp(htmlText) {
      const match = htmlText.match(/<!--Updated:\s*(.*?)-->/);
      return match ? new Date(match[1]) : null;
    }

    function convertToHST(dateObj) {
      const hstOffsetMs = 10 * 60 * 60 * 1000; // HST is UTC-10
      const utcTime = dateObj.getTime();
      const hstDate = new Date(utcTime - hstOffsetMs);
      return hstDate.toISOString().replace("T", " ").substring(0, 19) + " HST";
    }

    let lastUpdatedTime = null;
    let pollingInterval = null;
    let pollingTimeout = null;

    function startPollingForUpdate() {
      let elapsed = 0;
      statusText.innerHTML = "<span class='loader'></span> Waiting for table update...";

      pollingInterval = setInterval(() => {
        elapsed += 3;

        console.log("Polling... elapsed:", elapsed);
        fetch('https://raw.githubusercontent.com/sajusathish/fuel-log-review/main/RefreshedData')
          .then(res => res.text())
          .then(html => {
            const newTime = parseUpdatedTimestamp(html);

            if (!newTime) {
              console.warn("No timestamp found.");
              return;
            }

            console.log("Fetched timestamp:", newTime.toISOString());

            if (!lastUpdatedTime || newTime.getTime() !== lastUpdatedTime.getTime()) {
              console.log("New update detected!");
              lastUpdatedTime = newTime;
              clearInterval(pollingInterval);
              clearTimeout(pollingTimeout);
              tableContainer.innerHTML = html;
              statusText.innerHTML = `‚úÖ Table refreshed! Last update on ${convertToHST(newTime)}`;
            } else {
              console.log("No update detected.");
            }
          }).catch(err => {
            console.error("Polling error:", err);
          });

      }, 3000);

      pollingTimeout = setTimeout(() => {
        clearInterval(pollingInterval);
        statusText.innerHTML = `‚ö†Ô∏è No updates after 30 seconds. Last update was on ${lastUpdatedTime ? convertToHST(lastUpdatedTime) : "unknown"}`;
      }, 30000);
    }

    refreshBtn.onclick = () => {
      const formIds = [...document.querySelectorAll("input[name='selectForm']:checked")].map(i => i.value);
      if (formIds.length === 0) {
        statusText.innerHTML = "‚ö†Ô∏è Please select at least one form.";
        return;
      }

      const refreshUrl = "https://webhooks.workato.com/webhooks/rest/b7ed69d5-2da6-44d3-befd-c64b497884e8/refreshtable";
      statusText.innerHTML = "<span class='loader'></span> Refresh triggered...";

      fetch(refreshUrl)
        .then(() => {
          console.log("Triggered Workato refresh webhook:", refreshUrl);
          startPollingForUpdate();
        })
        .catch(err => {
          console.error("Error triggering refresh:", err);
          statusText.innerHTML = "‚ùå Failed to trigger refresh.";
        });
    };

    function submitAction(action) {
      const formIds = [...document.querySelectorAll("input[name='selectForm']:checked")].map(i => i.value);
      const reviewer = getQueryParam("Reviewer") || "unknown";
      if (formIds.length === 0) {
        statusText.innerHTML = "‚ö†Ô∏è Please select at least one form.";
        return;
      }

      statusText.innerHTML = `<span class='loader'></span> Submitting ${action}...`;

      fetch(`https://webhooks.workato.com/webhooks/rest/b7ed69d5-2da6-44d3-befd-c64b497884e8/fuel-log-response?status=${action}&Reviewer=${reviewer}&Form_Ids=${encodeURIComponent(formIds.join(","))}`)
        .then(res => res.text())
        .then(text => {
          statusText.innerHTML = "‚úÖ Response submitted: " + text;
        })
        .catch(err => {
          console.error("Submit error", err);
          statusText.innerHTML = "‚ùå Failed to submit response.";
        });
    }

    approveBtn.onclick = () => submitAction("Approved");
    rejectBtn.onclick = () => submitAction("Rejected");
  </script>
</body>
</html>
