<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Daily Fuel Log Review</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      padding: 1em;
      margin: 0;
      background: #f4f4f4;
    }
    h2 {
      margin-bottom: 0.5em;
    }
    #status {
      margin: 1em 0;
      font-weight: bold;
    }
    #tableContainer {
      width: 90vw;
      height: 70vh;
      overflow: auto;
      border: 1px solid #ccc;
      background: #fff;
      padding: 1em;
    }
    table {
      border-collapse: collapse;
      width: 100%;
    }
    th, td {
      border: 1px solid #ccc;
      padding: 0.5em;
      text-align: left;
    }
    .controls {
      margin: 1em 0;
    }
    button {
      padding: 0.5em 1em;
      margin-right: 0.5em;
      font-size: 1em;
    }
    #loading {
      display: none;
    }
  </style>
</head>
<body>
  <h2>Daily Fuel Log Review - <span id="todayDate"></span></h2>
  <div class="controls">
    <button id="refreshBtn">üîÑ Refresh</button>
    <button id="approveBtn">‚úÖ Approve</button>
    <button id="rejectBtn">‚ùå Reject</button>
    <span id="loading">‚è≥ Checking for updates...</span>
  </div>
  <div id="status">Waiting for refresh...</div>
  <div id="tableContainer"></div>

  <script>
    const todayDate = new Date().toISOString().split('T')[0];
    document.getElementById("todayDate").innerText = todayDate;

    const GITHUB_OWNER = 'sajusathish';
    const GITHUB_REPO = 'fuel-log-review';
    const GITHUB_PATH = 'fuel-log-table.html';
    const GITHUB_PAT = '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'; // Replace this securely in production

    const GITHUB_RAW_URL = `https://raw.githubusercontent.com/${GITHUB_OWNER}/${GITHUB_REPO}/main/${GITHUB_PATH}`;
    const GITHUB_COMMITS_API = `https://api.github.com/repos/${GITHUB_OWNER}/${GITHUB_REPO}/commits?path=${GITHUB_PATH}`;

    let lastCommitSHA = null;

    function decodeHTML(html) {
      const el = document.createElement("div");
      el.innerHTML = html;
      return el.innerText;
    }

    async function fetchTableFromURL() {
      const params = new URLSearchParams(window.location.search);
      const encodedHTML = params.get("data");
      if (encodedHTML) {
        try {
          const decodedHTML = atob(encodedHTML);
          document.getElementById("tableContainer").innerHTML = decodeHTML(decodedHTML);
        } catch {
          document.getElementById("status").innerText = "‚ö†Ô∏è Failed to decode base64 HTML.";
        }
      }
    }

    async function fetchLatestTableHTML() {
      const res = await fetch(GITHUB_RAW_URL, {
        headers: {
          Authorization: `token ${GITHUB_PAT}`,
          'Cache-Control': 'no-store'
        }
      });
      return await res.text();
    }

    async function fetchLatestCommitSHA() {
      const res = await fetch(GITHUB_COMMITS_API, {
        headers: {
          Authorization: `token ${GITHUB_PAT}`
        }
      });
      if (!res.ok) throw new Error("GitHub API error: " + res.status);
      const data = await res.json();
      return data[0]?.sha || null;
    }

    async function refreshTableAndCheckUpdates() {
      document.getElementById("loading").style.display = "inline";
      document.getElementById("status").innerText = "Checking for updates...";

      let initialSHA;
      try {
        initialSHA = await fetchLatestCommitSHA();
      } catch (e) {
        document.getElementById("status").innerText = "‚ùå Failed to fetch initial commit SHA.";
        document.getElementById("loading").style.display = "none";
        return;
      }

      let checkCount = 0;
      const checkInterval = setInterval(async () => {
        checkCount++;
        try {
          const currentSHA = await fetchLatestCommitSHA();
          if (currentSHA !== initialSHA) {
            const html = await fetchLatestTableHTML();
            document.getElementById("tableContainer").innerHTML = decodeHTML(html);
            document.getElementById("status").innerText = `‚úÖ Table refreshed! Last update on ${new Date().toLocaleString()}`;
            clearInterval(checkInterval);
            document.getElementById("loading").style.display = "none";
          } else if (checkCount * 7 >= 30) {
            const html = await fetchLatestTableHTML();
            document.getElementById("tableContainer").innerHTML = decodeHTML(html);
            document.getElementById("status").innerText = `‚ÑπÔ∏è No updates found.`;
            clearInterval(checkInterval);
            document.getElementById("loading").style.display = "none";
          }
        } catch (e) {
          document.getElementById("status").innerText = "‚ùå GitHub fetch error.";
          clearInterval(checkInterval);
          document.getElementById("loading").style.display = "none";
        }
      }, 7000);
    }

    async function triggerWebhook(status) {
      const table = document.querySelector("#tableContainer table");
      if (!table) return alert("No table data available");
      const rows = [...table.querySelectorAll("tbody tr")];
      const selected = rows.filter(row => row.querySelector("input[type='checkbox']")?.checked);
      if (selected.length === 0) return alert("Please select at least one row.");

      const Form_Ids = selected.map(r => r.cells[1]?.textContent.trim()).join(",");
      const Reviewer = "Manager";
      const webhookUrl = `https://webhooks.workato.com/webhooks/rest/b7ed69d5-2da6-44d3-befd-c64b497884e8/fuel-log-response?status=${status}&Form_Ids=${encodeURIComponent(Form_Ids)}&Reviewer=${Reviewer}`;

      document.getElementById("status").innerText = "‚è≥ Sending response...";
      try {
        const res = await fetch(webhookUrl);
        const txt = await res.text();
        document.getElementById("status").innerText = txt || "‚úÖ Response sent.";
      } catch (e) {
        document.getElementById("status").innerText = "‚ùå Webhook call failed.";
      }
    }

    document.getElementById("refreshBtn").addEventListener("click", refreshTableAndCheckUpdates);
    document.getElementById("approveBtn").addEventListener("click", () => triggerWebhook("Approved"));
    document.getElementById("rejectBtn").addEventListener("click", () => triggerWebhook("Rejected"));

    fetchTableFromURL(); // Initial load from URL if available
  </script>
</body>
</html>
