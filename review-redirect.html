<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Daily Fuel Log Review</title>
  <link href="https://unpkg.com/tabulator-tables@5.5.0/dist/css/tabulator_modern.min.css" rel="stylesheet">

  <style>
    :root{
      --ink:#2c3e50;
      --muted:#5d6d7e;
      --bg:#f6f8fb;
      --brand:#2980b9;
      --ok:#27ae60;
      --danger:#c0392b;
      --ring:rgba(41,128,185,.15);
      --line:#dfe6ee;
    }
    html, body{
      margin:0; padding:0; width:100%;
      font-family:'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background:var(--bg); color:#222;
      height:100vh; display:flex; flex-direction:column;
    }

    /* layout uses viewport width */
    .page-wrap{
      width:95vw;
      margin:22px auto 0;
    }

    .greeting{
      margin:0 0 4px;
      font-size:32px; font-weight:800; letter-spacing:.2px; color:var(--ink);
    }
    .subtext{
      margin:0 0 14px;
      font-size:14px; color:var(--muted);
    }

    /* camel case title, no uppercase transform */
    .date-title{
      display:flex; align-items:center; gap:10px;
      margin:0 0 10px;
      font-weight:500; color:var(--ink);
      font-size:16px; letter-spacing:.2px;
    }
    .date-chip{
      font-weight:300; font-size:13px; color:#1f2d3a;
      background:#e9f3ff; border:1px solid #d7e9ff;
      padding:2px 8px; border-radius:999px;
    }

    /* table full width */
    #fuel-log-table{
      width:100%;
      border:1px solid var(--line);
      border-radius:8px;
      box-sizing:border-box;
      background:#fff;
    }

    .buttons{
      width:100%;
      display:flex; gap:14px; align-items:center; justify-content:center;
      margin:16px 0 22px;
      flex-wrap:wrap;
    }
    button{
      cursor:pointer; border:none; height:42px; width:200px; border-radius:8px;
      font-size:15px; font-weight:700; color:#fff; background:var(--brand);
      box-shadow:0 6px 14px rgba(41,128,185,.18);
      transition:transform .15s, box-shadow .2s, background .2s;
      display:inline-flex; align-items:center; justify-content:center; gap:8px;
    }
    button:hover:not(:disabled){ transform:translateY(-2px); box-shadow:0 10px 18px rgba(0,0,0,.16); }
    button:disabled{ cursor:not-allowed; opacity:.6; box-shadow:none; transform:none; }
    button.approve{ background:var(--ok); }   button.approve:hover:not(:disabled){ background:#1e8449; }
    button.reject{ background:var(--danger); } button.reject:hover:not(:disabled){ background:#922b21; }

    #statusText{
      margin:0 0 6px; font-weight:600; color:#34495e; user-select:none; min-height:24px;
      width:100%; display:flex; justify-content:center; align-items:center; gap:8px;
    }
    .loader{ display:inline-block; width:18px; height:18px; border:3px solid rgba(0,0,0,.2); border-top:3px solid #34495e; border-radius:50%; animation:spin .8s linear infinite; }
    @keyframes spin{ 0%{transform:rotate(0)} 100%{transform:rotate(360deg)} }

    /* modal */
    .modal-overlay{ position:fixed; inset:0; background:rgba(0,0,0,.45); display:none; align-items:center; justify-content:center; z-index:9999; }
    .modal{
      width:min(560px,92vw); background:#fff; border-radius:12px; box-shadow:0 18px 40px rgba(0,0,0,.25);
      overflow:hidden; display:grid; grid-template-rows:auto 1fr auto; outline:none;
    }
    .modal-header{ display:flex; align-items:center; gap:12px; padding:16px 18px; border-bottom:1px solid #eef2f7; background:#fbfbfd; }
    .modal-icon{ width:28px; height:28px; display:inline-flex; align-items:center; justify-content:center; border-radius:6px; background:#fdecea; color:var(--danger); font-size:18px; }
    .modal-title{ font-size:18px; font-weight:800; color:var(--ink); margin:0; }
    .modal-body{ padding:16px 18px; display:grid; gap:12px; }
    .modal-help{ font-size:14px; color:var(--muted); }
    .badge{ display:inline-flex; align-items:center; gap:6px; font-size:12px; color:#2c3e50; background:#ecf5ff; border:1px solid #d6ebff; padding:4px 8px; border-radius:999px; width:max-content; }
    .modal textarea{
      width:100%; min-height:110px; border:1px solid #dce3ec; border-radius:10px; padding:10px 12px;
      font-family:inherit; font-size:14px; resize:vertical; outline:none; box-sizing:border-box; margin:0;
    }
    .modal textarea:focus{ border-color:var(--brand); box-shadow:0 0 0 3px var(--ring); }
    .char-hint{ font-size:12px; color:#7b8a97; text-align:right; margin-top:4px; padding-right:2px; }
    .modal-footer{ display:flex; justify-content:flex-end; gap:10px; padding:14px 18px; border-top:1px solid #eef2f7; background:#fbfbfd; }
    .btn-secondary{ background:#eef2f7; color:#2c3e50; } .btn-secondary:hover{ background:#e3e8ef; }
    .btn-danger{ background:var(--danger); color:#fff; } .btn-danger:hover{ background:#922b21; }

    /* tabulator visual tweaks */
    .tabulator{ border:none; }
    .tabulator-header{ border-bottom:1px solid var(--line); }
    .tabulator-row{ border-bottom:1px solid #f0f3f7; }
  </style>
</head>
<body>
  <div class="page-wrap">
    <div id="greeting" class="greeting">Hello</div>
    <p id="subtext" class="subtext">Review fuel logs. Select rows, then approve or reject forms. Its a good practice to refresh the table before approving or rejecting to avoid working on a outdated database.</p>

    <div class="date-title">
      <span id="titleText">Daily fuel log review</span>
      <span class="date-chip" id="todayDate"></span>
    </div>

    <div id="fuel-log-table"></div>

    <div class="buttons">
      <button id="refreshBtn" aria-label="Refresh Table">üîÑ Refresh Table</button>
      <button id="approveBtn" class="approve" aria-label="Approve Selected">‚úÖ Approve</button>
      <button id="rejectBtn" class="reject" aria-label="Reject Selected">‚ùå Reject</button>
    </div>

    <div id="statusText" aria-live="polite" role="status"></div>
  </div>

  <!-- Reject Modal -->
  <div id="rejectOverlay" class="modal-overlay" aria-hidden="true">
    <div id="rejectModal" class="modal" role="dialog" aria-modal="true" aria-labelledby="rejectTitle">
      <div class="modal-header">
        <span class="modal-icon">‚ö†Ô∏è</span>
        <h4 id="rejectTitle" class="modal-title">Reject selected logs</h4>
      </div>
      <div class="modal-body">
        <div class="badge" id="selectedCount">0 selected</div>
        <div class="modal-help">Add a short reason so the submitter knows what to fix.</div>
        <label for="rejectReason" class="modal-help" style="font-weight:600;color:#34495e;">Reason</label>
        <textarea id="rejectReason" placeholder="Example: Missing/wrong Equipment number,please resubmit..! ."></textarea>
        <div class="char-hint"><span id="chars">0</span>/500</div>
        <div id="rejectError" class="modal-help" style="color:#c0392b; display:none;">Please enter a reason.</div>
      </div>
      <div class="modal-footer">
        <button id="cancelReject" class="btn-secondary">Cancel</button>
        <button id="confirmReject" class="btn-danger">Submit rejection</button>
      </div>
    </div>
  </div>

  <script src="https://unpkg.com/tabulator-tables@5.5.0/dist/js/tabulator.min.js"></script>
  <script>
    document.getElementById("todayDate").textContent = new Date().toISOString().split("T")[0];

    const params = new URLSearchParams(window.location.search);
    const reviewer = params.get('reviewer') || 'unknown@domain.com';

    function nameFromEmail(mail){
      const local = (mail || '').split('@')[0] || '';
      if(!local) return 'Reviewer';
      return local.charAt(0).toUpperCase() + local.slice(1);
    }
    document.getElementById('greeting').textContent = `Hello ${nameFromEmail(reviewer)}`;
    document.getElementById('titleText').textContent = 'Daily fuel log review';

    function base64UrlDecode(input){
      try{
        const base64 = input.replace(/-/g,'+').replace(/_/g,'/');
        const decoded = atob(base64);
        return decodeURIComponent(escape(decoded));
      }catch(e){ console.error("Decode error", e); return null; }
    }

    function parseTableHTMLtoData(html){
      const parser = new DOMParser();
      const doc = parser.parseFromString(html, "text/html");
      const table = doc.querySelector("table");
      if(!table) return [];
      const headers = Array.from(table.querySelectorAll("thead th")).map(th => th.textContent.trim());
      const rows = Array.from(table.querySelectorAll("tbody tr"));
      return rows.map(row => {
        const cells = Array.from(row.querySelectorAll("td"));
        const obj = {};
        cells.forEach((cell, i) => { obj[headers[i] || `col${i}`] = cell.textContent.trim(); });
        return obj;
      });
    }

    function getColumnsFromHeaders(headers){
      const filtered = headers.filter(h => h.toLowerCase() !== 'select');
      return [{
        formatter:"rowSelection", titleFormatter:"rowSelection", hozAlign:"center", headerSort:false, width:50, frozen:true
      }].concat(filtered.map(h => ({
        title:h, field:h, headerFilter:"input", headerSort:true, resizable:true, hozAlign:"left", tooltip:true, visible: h === "Form ID" ? false : true
      })));
    }

    let table;
    const dataEncoded = params.get('data');
    if(dataEncoded){
      const tableHTML = base64UrlDecode(dataEncoded);
      if(tableHTML){
        const doc = new DOMParser().parseFromString(tableHTML, "text/html");
        const tableElement = doc.querySelector("table");
        if(tableElement){
          const headers = Array.from(tableElement.querySelectorAll("thead th")).map(th => th.textContent.trim());
          const tableData = parseTableHTMLtoData(tableHTML);
          const columns = getColumnsFromHeaders(headers);
          table = new Tabulator("#fuel-log-table", {
            data: tableData,
            layout: "fitDataStretch",
            movableColumns: true,
            resizableColumns: true,
            columns: columns,
            selectable: true,
            selectableCheck: () => true,
            rowClick: false,
            pagination: false,
            initialSort: [{ column: columns[1].field, dir: "asc" }]
          });
        } else {
          document.getElementById("fuel-log-table").innerHTML = "<p style='color:red;text-align:center;'>No table found in data.</p>";
        }
      } else {
        document.getElementById("fuel-log-table").innerHTML = "<p style='color:red;text-align:center;'>Failed to decode data.</p>";
      }
    } else {
      document.getElementById("fuel-log-table").innerHTML = "<p style='color:gray;text-align:center;'>No initial data provided.</p>";
    }

    function getSelectedFormIds(){
      const selected = table.getSelectedData();
      if(!selected.length) return "";
      if("Form ID" in selected[0]) return selected.map(r => r["Form ID"]).join(",");
      const keys = Object.keys(selected[0]);
      return selected.map(r => r[keys[0]]).join(",");
    }

    function toggleButtonsDisabled(disabled){
      document.getElementById("refreshBtn").disabled = disabled;
      document.getElementById("approveBtn").disabled = disabled;
      document.getElementById("rejectBtn").disabled = disabled;
    }

    async function handleDecision(status, extraParams = {}){
      const formIds = getSelectedFormIds();
      const statusText = document.getElementById("statusText");
      if(!formIds){ alert("Please select at least one form."); return; }
      const base = "https://webhooks.workato.com/webhooks/rest/b7ed69d5-2da6-44d3-befd-c64b497884e8/fuel-log-response";
      const qs = new URLSearchParams({ status, Reviewer: reviewer, Form_Ids: formIds, ...extraParams });
      const webhookUrl = `${base}?${qs.toString()}`;
      statusText.textContent = `Submitting ${status}...`;
      toggleButtonsDisabled(true);
      try{
        const response = await fetch(webhookUrl, { method:'GET' });
        if(!response.ok){ const err = await response.text(); throw new Error(`Webhook call failed: ${err}`); }
        statusText.textContent = `‚úÖ ${status} sent successfully!`;
      }catch(e){
        statusText.textContent = `‚ùå Error: ${e.message}`;
      }finally{
        toggleButtonsDisabled(false);
      }
    }

    document.getElementById("approveBtn").onclick = () => handleDecision("Approved");

    const overlay = document.getElementById("rejectOverlay");
    const modal = document.getElementById("rejectModal");
    const reasonEl = document.getElementById("rejectReason");
    const countEl = document.getElementById("selectedCount");
    const errEl = document.getElementById("rejectError");
    const charsEl = document.getElementById("chars");
    const cancelBtn = document.getElementById("cancelReject");
    const confirmBtn = document.getElementById("confirmReject");

    function openRejectModal(){
      const formIds = getSelectedFormIds();
      if(!formIds){ alert("Please select at least one form."); return; }
      const selectedCount = formIds.split(",").filter(Boolean).length;
      countEl.textContent = `${selectedCount} selected`;
      reasonEl.value = ""; if(charsEl) charsEl.textContent = "0"; errEl.style.display = "none";
      overlay.style.display = "flex"; overlay.setAttribute("aria-hidden","false"); modal.focus();
    }
    function closeRejectModal(){ overlay.style.display = "none"; overlay.setAttribute("aria-hidden","true"); }

    reasonEl.addEventListener("input", () => {
      const max = 500;
      if (reasonEl.value.length > max) reasonEl.value = reasonEl.value.slice(0, max);
      if(charsEl) charsEl.textContent = String(reasonEl.value.length);
      if (reasonEl.value.trim().length > 0) errEl.style.display = "none";
    });

    overlay.addEventListener("click", e => { if (e.target === overlay) closeRejectModal(); });
    document.addEventListener("keydown", e => { if (overlay.style.display === "flex" && e.key === "Escape") closeRejectModal(); });
    cancelBtn.addEventListener("click", closeRejectModal);

    confirmBtn.addEventListener("click", async () => {
      const reason = reasonEl.value.trim();
      if (!reason) { errEl.style.display = "block"; reasonEl.focus(); return; }
      closeRejectModal();
      await handleDecision("Rejected", { Rejection_Reason: reason });
    });

    document.getElementById("rejectBtn").onclick = openRejectModal;

    async function fetchRawFileContent(){
      const url = `https://raw.githubusercontent.com/sajusathish/fuel-log-review/main/RefreshedData?t=${Date.now()}`;
      const resp = await fetch(url, {cache:'no-store'});
      if(!resp.ok) throw new Error(`Fetch failed: ${resp.status}`);
      const txt = await resp.text();
      if(txt.trim().length < 10) throw new Error("Refreshed data too short");
      return txt;
    }

    async function refreshTable(){
      const statusText = document.getElementById("statusText");
      statusText.textContent = `Triggering refresh...`;
      statusText.insertAdjacentHTML('beforeend','<span class="loader"></span>');
      toggleButtonsDisabled(true);
      try{
        const webhookResp = await fetch("https://webhooks.workato.com/webhooks/rest/b7ed69d5-2da6-44d3-befd-c64b497884e8/refreshtable", { method:"GET", cache:"no-store" });
        if(!webhookResp.ok){ const errTxt = await webhookResp.text(); throw new Error(`Webhook trigger failed: ${errTxt}`); }
        statusText.textContent = `Polling for updates...`;
        statusText.insertAdjacentHTML('beforeend','<span class="loader"></span>');
        const getFormIds = (data) => data.map(r => r["Form ID"]).sort();
        const currentFormIds = getFormIds(table.getData());
        let retries = 3;
        while(retries-- > 0){
          await new Promise(r => setTimeout(r, 5000));
          try{
            const newTableHTML = await fetchRawFileContent();
            const newData = parseTableHTMLtoData(newTableHTML);
            const newFormIds = getFormIds(newData);
            const hasChanged = newFormIds.length !== currentFormIds.length || newFormIds.some((id, i) => id !== currentFormIds[i]);
            const timeString = new Date().toLocaleString("en-US", {
              timeZone:"Pacific/Honolulu", year:'numeric', month:'short', day:'numeric',
              hour:'2-digit', minute:'2-digit', second:'2-digit', timeZoneName:'short'
            });
            if(hasChanged){
              table.replaceData(newData);
              statusText.textContent = `‚úÖ Table refreshed! (Last Update: ${timeString})`;
              toggleButtonsDisabled(false); return;
            }
          }catch(err){
            statusText.textContent = `‚ùå Error fetching update: ${err.message}`;
            toggleButtonsDisabled(false); return;
          }
        }
        const finalTime = new Date().toLocaleString("en-US", {
          timeZone:"Pacific/Honolulu", year:'numeric', month:'short', day:'numeric',
          hour:'2-digit', minute:'2-digit', second:'2-digit', timeZoneName:'short'
        });
        statusText.textContent = `‚ö†Ô∏è No updates found! (Last Update: ${finalTime})`;
      }catch(e){
        statusText.textContent = `‚ùå Refresh failed: ${e.message}`;
      }finally{
        toggleButtonsDisabled(false);
      }
    }
    document.getElementById("refreshBtn").onclick = refreshTable;
  </script>
</body>
</html>
