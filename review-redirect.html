<!DOCTYPE html>
<html>
<head>
  <title>Daily Fuel Log Review</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 40px;
      background: #f4f6f8;
    }
    h3 {
      text-align: center;
      margin-bottom: 30px;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      background: white;
      box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
    }
    th, td {
      border: 1px solid #ddd;
      padding: 10px;
      text-align: center;
      font-size: 14px;
    }
    th {
      background-color: #2c3e50;
      color: white;
      position: sticky;
      top: 0;
    }
    tr:nth-child(even) {
      background-color: #f9f9f9;
    }
    .buttons {
      margin-top: 30px;
      text-align: center;
    }
    button {
      padding: 12px 25px;
      margin: 0 15px;
      font-size: 16px;
      cursor: pointer;
      border: none;
      border-radius: 6px;
      transition: background-color 0.3s ease;
    }
    .approve { background-color: #27ae60; color: white; }
    .approve:hover { background-color: #219150; }
    .reject { background-color: #c0392b; color: white; }
    .reject:hover { background-color: #a93226; }
    .refresh { background-color: #2980b9; color: white; }
    .refresh:hover { background-color: #2471a3; }
    #statusText {
      margin-top: 20px;
      text-align: center;
      font-size: 16px;
      font-weight: bold;
    }
  </style>
</head>
<body>
  <h3>Daily Fuel Log Review - <span id="todayDate"></span></h3>
  <div class="buttons">
    <button class="approve" id="approveBtn">Approve</button>
    <button class="reject" id="rejectBtn">Reject</button>
    <button class="refresh" id="refreshBtn">🔄 Refresh</button>
  </div>
  <div id="statusText"></div>
  <div id="tableContainer"></div>

  <script>
    document.getElementById("todayDate").textContent = new Date().toISOString().split("T")[0];
    const reviewer = new URLSearchParams(window.location.search).get("reviewer") || "unknown@domain.com";
    const githubRawURL = "https://raw.githubusercontent.com/sajusathish/fuel-log-review/main/RefreshedData";
    let pollingInterval;
    let previousTimestamp = "";

    async function getLastUpdatedHST() {
      const response = await fetch(githubRawURL, { cache: "no-store" });
      const html = await response.text();
      const match = html.match(/<!--Updated: (.*?)-->/);
      if (match) {
        const utc = new Date(match[1]);
        const utcTime = utc.getTime();
        const hstOffset = -10 * 60 * 60 * 1000;
        const hst = new Date(utcTime + hstOffset);
        return {
          date: hst.toLocaleString("en-US", { timeZone: "UTC" }) + " HST",
          raw: match[1],
          content: html
        };
      }
      return null;
    }

    async function refreshTable() {
      console.log("🔄 Refresh clicked. Checking current update time...");
      const initial = await getLastUpdatedHST();
      if (!initial) {
        document.getElementById("statusText").textContent = "❌ Could not fetch initial timestamp.";
        return;
      }

      previousTimestamp = initial.raw;
      document.getElementById("statusText").textContent = "⏳ Fetching new data...";
      document.getElementById("tableContainer").innerHTML = ""; // Clear old table
      console.log(`📌 Initial timestamp: ${initial.raw}`);

      fetch("https://webhooks.workato.com/webhooks/rest/b7ed69d5-2da6-44d3-befd-c64b497884e8/refreshtable")
        .then(res => res.text())
        .then(_ => {
          console.log("✅ Workato webhook triggered successfully");
          startPolling(initial.raw);
        })
        .catch(err => {
          console.error("❌ Error triggering webhook:", err);
          document.getElementById("statusText").textContent = "❌ Error triggering refresh.";
        });
    }

    function startPolling(initialTimestamp) {
      console.log("⏳ Starting polling for updates every 3s for 30s...");
      let attempts = 0;
      clearInterval(pollingInterval);

      pollingInterval = setInterval(async () => {
        attempts++;
        console.log(`🔁 Poll #${attempts}`);
        const latest = await getLastUpdatedHST();
        if (!latest) return;

        if (latest.raw !== initialTimestamp) {
          clearInterval(pollingInterval);
          console.log("✅ New update found. Refreshing table...");
          document.getElementById("tableContainer").innerHTML = latest.content;
          document.getElementById("statusText").textContent = `✅ Table refreshed! Last update on ${latest.date}`;
          previousTimestamp = latest.raw;
        } else if (attempts >= 10) {
          clearInterval(pollingInterval);
          console.log("⚠️ No update detected after 30 seconds.");
          document.getElementById("statusText").textContent = `⚠️ No updates found. Last updated at ${latest.date}`;
        }
      }, 3000);
    }

    function getSelectedFormIds() {
      const checkboxes = document.querySelectorAll("input[type='checkbox'][name='selectForm']:checked");
      return Array.from(checkboxes).map(cb => cb.value).join(",");
    }

    function handleDecision(status) {
      const formIds = getSelectedFormIds();
      const statusText = document.getElementById("statusText");
      if (!formIds) return alert("Please select at least one form.");
      const webhookUrl = `https://webhooks.workato.com/webhooks/rest/b7ed69d5-2da6-44d3-befd-c64b497884e8/fuel-log-response?status=${encodeURIComponent(status)}&Reviewer=${encodeURIComponent(reviewer)}&FormIds=${encodeURIComponent(formIds)}`;
      console.log(`📤 Submitting status: ${status} for forms: ${formIds}`);
      statusText.textContent = `Submitting ${status}...`;

      fetch(webhookUrl)
        .then(response => {
          if (!response.ok) throw new Error("Webhook call failed");
          statusText.textContent = `✅ ${status} request sent successfully!`;
        })
        .catch(error => {
          console.error("❌ Submission error:", error);
          statusText.textContent = `❌ Error: ${error.message}`;
        });
    }

    document.getElementById("approveBtn").onclick = () => handleDecision("Approved");
    document.getElementById("rejectBtn").onclick = () => handleDecision("Rejected");
    document.getElementById("refreshBtn").onclick = refreshTable;
  </script>
</body>
</html>
